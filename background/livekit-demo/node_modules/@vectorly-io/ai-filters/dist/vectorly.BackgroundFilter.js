!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.vectorly=t():(e.vectorly=e.vectorly||{},e.vectorly.BackgroundFilter=t())}(self,(function(){return function(){var e,t,r={435:function(e){e.exports=["cnn_demo","residual_3k_3x","residual_4k_2x","residual_5k_2x","residual_5k_3x","denoise_10k_1x","background_meet"]},645:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return d}});var i=r(877),n=r(477),s=r.n(n);function o(){return s()('!function(){var e={435:function(e){e.exports=["cnn_demo","residual_3k_3x","residual_4k_2x","residual_5k_2x","residual_5k_3x","denoise_10k_1x","background_meet"]}},t={};function r(n){var o=t[n];if(void 0!==o)return o.exports;var i=t[n]={exports:{}};return e[n](i,i.exports,r),i.exports}r.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),function(){var e;r.g.importScripts&&(e=r.g.location+"");var t=r.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var n=t.getElementsByTagName("script");n.length&&(e=n[n.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\\?.*$/,"").replace(/\\/[^\\/]+$/,"/"),r.p=e}(),function(){"use strict";function e(){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope}function t(){return e()?(self.isWorker=!0,self):(window.isWorker=!1,window)}function n(t){return e()?t instanceof OffscreenCanvasRenderingContext2D:t instanceof CanvasRenderingContext2D}var o=function(e,r){let n;"string"==typeof e&&(e=document.getElementById(e));let o=1;if("true"===r.use_webgl1?(n=e.getContext("webgl"),console.log("Using Webgl 1")):(n=e.getContext("webgl2"),o=2,n?console.log("Using Webgl 2"):(o=1,n=e.getContext("webgl"),console.log("Using Webgl 1"))),n.getExtension("WEBGL_draw_buffers")?n.disable_multi_draw=r.disable_multi_draw||!1:n.disable_multi_draw=!0,n.extensions={},n.getVersion=function(){return o},1===n.getVersion()){if("float32"===r.float_type){if(n.extensions.EXT_FLOAT=n.getExtension("OES_texture_float"),!n.extensions.EXT_FLOAT)throw new Error("Extension not found: OES_texture_float");n.extensions.EXT_FLOAT_LINEAR=n.getExtension("OES_texture_float_linear"),n.extensions.EXT_FLOAT_LINEAR||console.warn("Extension not found: OES_texture_float_linear"),n.texture_format=n.RGBA,n.texture_type=n.FLOAT}else{if(n.extensions.EXT_FLOAT=n.getExtension("OES_texture_half_float"),!n.extensions.EXT_FLOAT)throw new Error("Extension not found: OES_texture_half_float");n.extensions.EXT_FLOAT_LINEAR=n.getExtension("OES_texture_half_float_linear"),n.extensions.EXT_FLOAT_LINEAR||console.warn("Extension not found: OES_texture_half_float_linear"),n.texture_format=n.RGBA,n.texture_type=n.extensions.EXT_FLOAT.HALF_FLOAT_OES}if(n.disable_multi_draw)console.log("Multi Draw Disabled");else if(console.log("Multi Draw Enabled"),n.extensions.WEBGL_draw_buffers=n.getExtension("WEBGL_draw_buffers"),!n.extensions.WEBGL_draw_buffers)throw new Error("Extension not found: WEBGL_draw_buffers")}else{if(n.extensions.EXT_FLOAT=n.getExtension("EXT_color_buffer_float"),!n.extensions.EXT_FLOAT)throw new Error("Extension not found: EXT_color_buffer_float");"float32"===r.float_type?(n.extensions.EXT_FLOAT_LINEAR=n.getExtension("OES_texture_float_linear"),n.texture_format=n.RGBA32F,n.texture_type=n.FLOAT):(n.extensions.EXT_FLOAT_LINEAR=n.getExtension("OES_texture_half_float_linear"),n.texture_format=n.RGBA16F,n.texture_type=n.FLOAT)}return console.log(n.texture_format,n.texture_type),1===n.getVersion()?(n.getCOLOR_ATTACHMENT=function(e=0){return n.disable_multi_draw?(e>0&&console.warn("Slot cannot be greater than 0 when multi draw is disabled"),n.COLOR_ATTACHMENT0):n.extensions.WEBGL_draw_buffers.COLOR_ATTACHMENT0_WEBGL+e},n.getDrawBuffers=function(e=[n.getCOLOR_ATTACHMENT(0)]){n.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(e)}):(n.getCOLOR_ATTACHMENT=function(e=0){return n.COLOR_ATTACHMENT0+e},n.getDrawBuffers=function(e=[n.getCOLOR_ATTACHMENT(0)]){n.drawBuffers(e)}),t().gl=n,n||console.log("WebGL Not Supported"),n.canvas.w=n.canvas.width,n.canvas.h=n.canvas.height,n.clearCanvas=function(){n.clearColor(0,0,0,1),n.viewport(0,0,n.drawingBufferWidth,n.drawingBufferHeight),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT|n.STENCIL_BUFFER_BIT)},n.input={h:r.h,w:r.w},n.render_scale={h:1,w:1},n.viewport(0,0,e.width,e.height),n.createAndCompileShader=function(e,t){let r=n.createShader(e);if(n.shaderSource(r,t),n.compileShader(r),!n.getShaderParameter(r,n.COMPILE_STATUS))throw new Error(n.getShaderInfoLog(r));return r},n.createAndLinkProgram=function(e,t){let r=n.createProgram();if(n.attachShader(r,e),n.attachShader(r,t),n.linkProgram(r),!n.getProgramParameter(r,n.LINK_STATUS))throw new Error(n.getProgramInfoLog(r));return r},n.resizeCanvasToDisplaySize=function(t,r){return(e.width!==t||e.height!==r)&&(e.width=t,e.height=r,!0)},n.resizeRenderSize=function(e,t,r){let o=r*n.input.w,i=r*n.input.h;o=e>o?e:o,i=t>i?t:i,n.render_scale={w:e/o,h:t/i},n.resizeCanvasToDisplaySize(o,i)},n};r(435);var i="undefined"!=typeof globalThis&&globalThis||"undefined"!=typeof self&&self||void 0!==i&&i,s="URLSearchParams"in i,a="Symbol"in i&&"iterator"in Symbol,l="FileReader"in i&&"Blob"in i&&function(){try{return new Blob,!0}catch(e){return!1}}(),u="FormData"in i,f="ArrayBuffer"in i;if(f)var h=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],c=ArrayBuffer.isView||function(e){return e&&h.indexOf(Object.prototype.toString.call(e))>-1};function d(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\\-#$%&\'*+.^_`|~!]/i.test(e)||""===e)throw new TypeError(\'Invalid character in header field name: "\'+e+\'"\');return e.toLowerCase()}function p(e){return"string"!=typeof e&&(e=String(e)),e}function g(e){var t={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return a&&(t[Symbol.iterator]=function(){return t}),t}function T(e){this.map={},e instanceof T?e.forEach((function(e,t){this.append(t,e)}),this):Array.isArray(e)?e.forEach((function(e){this.append(e[0],e[1])}),this):e&&Object.getOwnPropertyNames(e).forEach((function(t){this.append(t,e[t])}),this)}function _(e){if(e.bodyUsed)return Promise.reject(new TypeError("Already read"));e.bodyUsed=!0}function E(e){return new Promise((function(t,r){e.onload=function(){t(e.result)},e.onerror=function(){r(e.error)}}))}function w(e){var t=new FileReader,r=E(t);return t.readAsArrayBuffer(e),r}function m(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function y(){return this.bodyUsed=!1,this._initBody=function(e){var t;this.bodyUsed=this.bodyUsed,this._bodyInit=e,e?"string"==typeof e?this._bodyText=e:l&&Blob.prototype.isPrototypeOf(e)?this._bodyBlob=e:u&&FormData.prototype.isPrototypeOf(e)?this._bodyFormData=e:s&&URLSearchParams.prototype.isPrototypeOf(e)?this._bodyText=e.toString():f&&l&&(t=e)&&DataView.prototype.isPrototypeOf(t)?(this._bodyArrayBuffer=m(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):f&&(ArrayBuffer.prototype.isPrototypeOf(e)||c(e))?this._bodyArrayBuffer=m(e):this._bodyText=e=Object.prototype.toString.call(e):this._bodyText="",this.headers.get("content-type")||("string"==typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):s&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},l&&(this.blob=function(){var e=_(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?_(this)||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer)):this.blob().then(w)}),this.text=function(){var e,t,r,n=_(this);if(n)return n;if(this._bodyBlob)return e=this._bodyBlob,r=E(t=new FileReader),t.readAsText(e),r;if(this._bodyArrayBuffer)return Promise.resolve(function(e){for(var t=new Uint8Array(e),r=new Array(t.length),n=0;n<t.length;n++)r[n]=String.fromCharCode(t[n]);return r.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},u&&(this.formData=function(){return this.text().then(A)}),this.json=function(){return this.text().then(JSON.parse)},this}T.prototype.append=function(e,t){e=d(e),t=p(t);var r=this.map[e];this.map[e]=r?r+", "+t:t},T.prototype.delete=function(e){delete this.map[d(e)]},T.prototype.get=function(e){return e=d(e),this.has(e)?this.map[e]:null},T.prototype.has=function(e){return this.map.hasOwnProperty(d(e))},T.prototype.set=function(e,t){this.map[d(e)]=p(t)},T.prototype.forEach=function(e,t){for(var r in this.map)this.map.hasOwnProperty(r)&&e.call(t,this.map[r],r,this)},T.prototype.keys=function(){var e=[];return this.forEach((function(t,r){e.push(r)})),g(e)},T.prototype.values=function(){var e=[];return this.forEach((function(t){e.push(t)})),g(e)},T.prototype.entries=function(){var e=[];return this.forEach((function(t,r){e.push([r,t])})),g(e)},a&&(T.prototype[Symbol.iterator]=T.prototype.entries);var b=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function x(e,t){if(!(this instanceof x))throw new TypeError(\'Please use the "new" operator, this DOM object constructor cannot be called as a function.\');var r,n,o=(t=t||{}).body;if(e instanceof x){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new T(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,o||null==e._bodyInit||(o=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"same-origin",!t.headers&&this.headers||(this.headers=new T(t.headers)),this.method=(n=(r=t.method||this.method||"GET").toUpperCase(),b.indexOf(n)>-1?n:r),this.mode=t.mode||this.mode||null,this.signal=t.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&o)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(o),!("GET"!==this.method&&"HEAD"!==this.method||"no-store"!==t.cache&&"no-cache"!==t.cache)){var i=/([?&])_=[^&]*/;i.test(this.url)?this.url=this.url.replace(i,"$1_="+(new Date).getTime()):this.url+=(/\\?/.test(this.url)?"&":"?")+"_="+(new Date).getTime()}}function A(e){var t=new FormData;return e.trim().split("&").forEach((function(e){if(e){var r=e.split("="),n=r.shift().replace(/\\+/g," "),o=r.join("=").replace(/\\+/g," ");t.append(decodeURIComponent(n),decodeURIComponent(o))}})),t}function R(e,t){if(!(this instanceof R))throw new TypeError(\'Please use the "new" operator, this DOM object constructor cannot be called as a function.\');t||(t={}),this.type="default",this.status=void 0===t.status?200:t.status,this.ok=this.status>=200&&this.status<300,this.statusText=void 0===t.statusText?"":""+t.statusText,this.headers=new T(t.headers),this.url=t.url||"",this._initBody(e)}x.prototype.clone=function(){return new x(this,{body:this._bodyInit})},y.call(x.prototype),y.call(R.prototype),R.prototype.clone=function(){return new R(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new T(this.headers),url:this.url})},R.error=function(){var e=new R(null,{status:0,statusText:""});return e.type="error",e};var v=[301,302,303,307,308];R.redirect=function(e,t){if(-1===v.indexOf(t))throw new RangeError("Invalid status code");return new R(null,{status:t,headers:{location:e}})};var B=i.DOMException;try{new B}catch(e){(B=function(e,t){this.message=e,this.name=t;var r=Error(e);this.stack=r.stack}).prototype=Object.create(Error.prototype),B.prototype.constructor=B}function O(e,t){return new Promise((function(r,n){var o=new x(e,t);if(o.signal&&o.signal.aborted)return n(new B("Aborted","AbortError"));var s=new XMLHttpRequest;function a(){s.abort()}s.onload=function(){var e,t,n={status:s.status,statusText:s.statusText,headers:(e=s.getAllResponseHeaders()||"",t=new T,e.replace(/\\r?\\n[\\t ]+/g," ").split("\\r").map((function(e){return 0===e.indexOf("\\n")?e.substr(1,e.length):e})).forEach((function(e){var r=e.split(":"),n=r.shift().trim();if(n){var o=r.join(":").trim();t.append(n,o)}})),t)};n.url="responseURL"in s?s.responseURL:n.headers.get("X-Request-URL");var o="response"in s?s.response:s.responseText;setTimeout((function(){r(new R(o,n))}),0)},s.onerror=function(){setTimeout((function(){n(new TypeError("Network request failed"))}),0)},s.ontimeout=function(){setTimeout((function(){n(new TypeError("Network request failed"))}),0)},s.onabort=function(){setTimeout((function(){n(new B("Aborted","AbortError"))}),0)},s.open(o.method,function(e){try{return""===e&&i.location.href?i.location.href:e}catch(t){return e}}(o.url),!0),"include"===o.credentials?s.withCredentials=!0:"omit"===o.credentials&&(s.withCredentials=!1),"responseType"in s&&(l?s.responseType="blob":f&&o.headers.get("Content-Type")&&-1!==o.headers.get("Content-Type").indexOf("application/octet-stream")&&(s.responseType="arraybuffer")),!t||"object"!=typeof t.headers||t.headers instanceof T?o.headers.forEach((function(e,t){s.setRequestHeader(t,e)})):Object.getOwnPropertyNames(t.headers).forEach((function(e){s.setRequestHeader(e,p(t.headers[e]))})),o.signal&&(o.signal.addEventListener("abort",a),s.onreadystatechange=function(){4===s.readyState&&o.signal.removeEventListener("abort",a)}),s.send(void 0===o._bodyInit?null:o._bodyInit)}))}O.polyfill=!0,i.fetch||(i.fetch=O,i.Headers=T,i.Request=x,i.Response=R);let S=async(e,n={})=>{let o=((n=n||{}).path||r.p)+`models/${e}.js`;console.log(o),n.token&&(o=o+"?"+n.token);let i=t();var s;return i.isWorker?importScripts(o):await(s=o,new Promise(((e,t)=>{const r="$importModule$"+Math.random().toString(32).slice(2),n=document.createElement("script"),o=()=>{delete window[r],n.onerror=null,n.onload=null,n.remove(),URL.revokeObjectURL(n.src),n.src=""};n.defer="defer",n.type="module",n.onerror=()=>{t(new Error(`Failed to import: ${s}`)),o()},n.onload=()=>{e(window[r]),o()};const i=function(e){const t=document.createElement("a");return t.setAttribute("href",e),t.cloneNode(!1).href}(s),a=new Blob([`import * as m from "${i}"; window.${r} = m;`],{type:"text/javascript"});n.src=URL.createObjectURL(a),document.head.appendChild(n)}))),i.vectorlyBasePath=n.path||r.p,i.vectorly.models[e]},k=async(e,t,n,o)=>{if(o=o||{},"background_meet"===e){let i=(o.path||r.p)+`./data/${e}/${t}_v${n}.tflite`;o.token&&(i=i+"?"+o.token);const s=await fetch(i);if(!s.ok)throw Error(`Response fetching "${i}": ${s.statusText}`);return{model:await s.arrayBuffer()}}{let i=(o.path||r.p)+`./data/${e}/${t}_v${n}.json`;o.token&&(i=i+"?"+o.token);const s=await fetch(i);return await s.json()}};function L(e,t){const{cmd:r,msgId:n}=e;"render"!==r&&console.log("sendCmdStatus; data:",e,"retVal:",t);const o="w-"+r;"render"===r?self.postMessage({cmd:o,msgId:n,ret:t},[t.bitmap]):self.postMessage({cmd:o,msgId:n,ret:t})}self.glWorker=new class{constructor(){}async getNetwork(e){const{name:t,token:r}=e;this.NetworkClass=await S(t,r)}async getParameters(e){const{name:t,tag:r,version:n,token:o}=e;this.networkParameters=await k(t,r,n,o)}async initWebGLContext(e){const{canvas:t,options:r}=e;return this.gl=new o(t,r),!0}async render(e){const{inputImage:t}=e;return this.frameBuffer&&this.frameBuffer.setInputImage(t),this.renderer&&await this.renderer.render(),{bitmap:await createImageBitmap(this.gl.canvas)}}async instantiateNetwork(r){if(this.networkOptions=r.networkOptions,this.gl)return this.frameBuffer=new class{constructor(e){this.gl=e,this.iterations=0,this.textures=[{},{}],this.frame_buffers=[{},{}],this.inputTex=null,this.inputCanvas=null,this.frame_difference=0}drawToCanvas(){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}setBuffer(e){const t=this.gl,r=this.iterations%2*this.frame_difference;t.bindFramebuffer(t.FRAMEBUFFER,this.frame_buffers[r][e])}setInputFrameCanvas(){console.log("setting up the canvas: "),t(),n(this.inputCanvas)?console.log("Canvas already created"):(this.inputCanvas=function(t,r){if(e())return new OffscreenCanvas(t,r);{const e=document.createElement("canvas");return e.width=t,e.height=r,e}}(this.gl.input.w,this.gl.input.h).getContext("2d"),console.log("canvas creation complete")),console.log("updating the canvas resolution"),this.inputCanvas.canvas.width=this.gl.input.w,this.inputCanvas.canvas.height=this.gl.input.h}videoToCanvas(e){return this.inputCanvas.drawImage(e,0,0,this.gl.input.w,this.gl.input.h),this.inputCanvas.canvas}getInputTexture(){const e=this.gl;return null===this.inputTex&&(this.inputTex=e.createTexture()),this.inputTex}setInputImage(e,t=!1){t=t||!1,this.input=e;const r=this.gl,o=this.getInputTexture();r.bindTexture(r.TEXTURE_2D,o),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),n(this.inputCanvas)&&(e=this.videoToCanvas(e)),r.texImage2D(r.TEXTURE_2D,0,r.texture_format,r.RGBA,r.texture_type,e);for(let e=0;e<=this.frame_difference;e++)this.textures[e].INPUT=[o]}createBufferWithTextures(e,t,r=1,n=null){const o=this.gl;for(let i=0;i<=this.frame_difference;i++){const s=o.createFramebuffer();this.frame_buffers[i][e]=s,o.bindFramebuffer(o.FRAMEBUFFER,s);const a=[];this.textures[i][e]=null;for(let e=0;e<t;++e){const t=this.createAndSetupTexture(n);a.push(t),o.bindTexture(o.TEXTURE_2D,t),o.texImage2D(o.TEXTURE_2D,0,o.texture_format,o.input.w*r,o.input.h*r,0,o.RGBA,o.texture_type,null),o.framebufferTexture2D(o.FRAMEBUFFER,o.getCOLOR_ATTACHMENT(e),o.TEXTURE_2D,t,0)}this.textures[i][e]=a}}createTexture_webgl2(e,t,r,n=gl.NEAREST,o=gl.NEAREST){const i=gl.createTexture();return gl.bindTexture(gl.TEXTURE_2D,i),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,n),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,o),gl.texStorage2D(gl.TEXTURE_2D,1,e,t,r),i}createTexture_webgl1(e,t,r,n,o,i=gl.NEAREST,s=gl.NEAREST){const a=gl.createTexture();return gl.bindTexture(gl.TEXTURE_2D,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,i),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,s),gl.texImage2D(gl.TEXTURE_2D,0,e,t,r,0,n,o,null),a}setBufferForLayer(e,t){for(let r=0;r<=this.frame_difference;r++){const n=gl.createFramebuffer();this.frame_buffers[r][e]=n,gl.bindFramebuffer(gl.FRAMEBUFFER,n);for(let e=0;e<t.length;e++)gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.getCOLOR_ATTACHMENT(e),gl.TEXTURE_2D,t[e],0);this.textures[r][e]=t}}getTexture(e){const t=this.iterations%2*this.frame_difference;return this.textures[t][e]}getLastFrameTexture(e){const t=1-this.iterations%2;return this.textures[t][e]}clearall(){let e=Object.keys(this.textures[0]);console.log("clearing buffers and textures..."),e.forEach((e=>{for(let t=0;t<=this.frame_difference;t++){this.gl.deleteFramebuffer(this.frame_buffers[t][e]),this.frame_buffers[t][e]=null;for(let r=0;r<this.textures[t][e].length;++r)this.gl.deleteTexture(this.textures[t][e][r]),this.textures[t][e][r]=null}})),this.gl.deleteTexture(this.inputTex),this.inputTex=null,this.inputCanvas=null,this.frame_buffers=[{},{}],this.textures=[{},{}],this.gl.clearCanvas()}createAndSetupTexture(e=null){const t=this.gl;t.extensions.EXT_FLOAT_LINEAR||(e=null),null===e&&(e=t.NEAREST);const r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),r}}(this.gl),this.networkInstance=new this.NetworkClass(this.gl,this.frameBuffer,this.networkParameters,this.networkOptions),this.initialized=this.networkInstance.initialized,await this.initialized,!0;throw Error(`this.gl is ${this.gl}: maybe called instantiateNetwork without calling initWebGLContext?`)}async initRenderer(e){return this.renderInputSize=e.renderInputSize,this.renderer=new class{constructor(e,t,r,n){this.gl=e,this.network=t,this.frameBuffer=r,this.renderSize={w:n.w,h:n.h},this.metrics={"Render Size":this.renderSize,"Original Size":e.input,"Upscale Factor":t.upscaleFactor,FPS:0},this.setProperties(n)}setProperties(e={w:1278,h:720,disableVideoToCanvas:!1}){const t=this;!0!==e.disableVideoToCanvas&&this.frameBuffer.setInputFrameCanvas(),void 0===e.w&&(e.w=this.network.upscaleFactor*this.gl.input.w),void 0===e.h&&(e.h=this.network.upscaleFactor*this.gl.input.h),this.renderSize=e,console.log("%cNew renderSize:","background:black; color: red",this.renderSize),this.gl.resizeRenderSize(e.w,e.h,this.network.upscaleFactor),null!==this.frameBuffer.inputTex&&setTimeout((()=>{t.network.renderRGB(t.gl.render_scale)})),t.metrics["Render Size"]=e}setInputSize(e={w:426,h:240}){this.gl.input={w:e.w,h:e.h},console.log("%cNew Input Size:","background:black; color: green",gl.input),this.network.resetTextureBuffers(),this.setProperties(this.renderSize)}async resetNetwork(e){this.frameBuffer.clearall(),this.network=await async function(e={name:"",version:"",tag:"",token:""},t,r){let n=null,o=null;try{o=await k(e.name,e.tag,e.version,e.token)}catch(e){throw console.log("%cParameter load failed:","background:black; color: yellow"),new Error(e)}if(!o)throw console.log("%cParameter load failed:","background:black; color: yellow"),new Error("");try{const i=S(e.name,e.token);n=await i,n=new n(t,r,o)}catch(e){throw console.log("%cNetwork load failed:","background:black; color: yellow"),new Error(e)}return n}({name:e.name,version:e.version,tag:e.tag},this.gl,this.network.frameBuffer),this.frameBuffer=this.network.frameBuffer,this.gl=this.network.gl,this.setProperties(this.renderSize)}changeNetwork(e){this.network=e,this.frameBuffer=this.network.frameBuffer,this.gl=this.network.gl}loadBitmap(e){const t=this.frameBuffer;this.network,t.setInputImage(e),this.render()}loadImage(e){const t=new Image;t.src=e;const r=this.frameBuffer,n=this,o=this.network;t.onload=function(){r.setInputImage(t),n.render(),o.getImageBytes()}}async render(){const e=this.gl,t=this.network;e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),await t.feedForward(e.render_scale)}}(this.gl,this.networkInstance,this.frameBuffer,this.renderInputSize),!0}async setRenderSize(e){this.renderInputSize=e.renderInputSize,this.renderer&&this.renderer.setProperties(this.renderInputSize)}async setInputSize(e){this.inputSize=e.inputSize,this.renderer&&this.renderer.setInputSize(this.inputSize)}async changeNetwork(e){this.networkOptions=e.networkOptions,this.gl&&(this.frameBuffer&&this.frameBuffer.clearall(),this.networkInstance=new this.NetworkClass(this.gl,this.frameBuffer,this.networkParameters,this.networkOptions),this.renderer.changeNetwork(this.networkInstance))}async updateOptions(e){const{update:t}=e;await this.networkInstance.updateOptions(t)}},self.onmessage=async function(e){const{cmd:t,params:r}=e.data;if(self.glWorker[t]&&"function"==typeof self.glWorker[t])try{const n=await self.glWorker[t](r);L(e.data,n)}catch(t){console.log("Caught error",t),L(e.data,{error:t.toString()})}else L(e.data,{error:`No function ${t} for glWorker`})}}()}();',"Worker",void 0,void 0)}var a=r(33),h=r(8),l=r(306),c=r(820),d=class{constructor(e,t){console.log("Initialized upscaler with",e);const r=t;this.video=e,this.stream=r.stream,this.id=r.id||(0,i.v4)(),this.videoParent=e.parentNode,this.token=r.token,this.serverType=r.serverType,this.webgl,this.fixaspectratio=r.fixaspectratio||!0,this.inputChangePreHook=r.inputChangePreHook||(()=>!0),this.renderSize=r.renderSize,"disable"===r.container?this.container=null:this.container=r.container||e.parentNode,console.log("Container is",this.container),this.container&&(this.container.style.background="black",this.container.style.resize="both",this.container.style.overflow="hidden",this.ro=this.getResizeObserver(this.setRenderSize.bind(this)),this.ro.observe(this.container)),this.margin={top:0,left:0},this.use_webgl1=r.use_webgl1||"false",this.float_type=r.float_type||"float16",this.scale=r.scale||3,r.networkParams=r.networkParams||{},this.networkParams={name:"residual_3k_3x",tag:"general",version:"2.1"},this.networkParams=Object.assign(this.networkParams,r.networkParams),this.networkOptions=r.networkOptions||{},(r.network||r.tag||r.version)&&(this.networkParams.name=r.network||this.networkParams.name,this.networkParams.tag=r.tag||this.networkParams.tag,"residual_3k_3x"===this.networkParams.name?this.networkParams.version=r.version||r.networkParams.version||"2.1":this.networkParams.version=r.version||r.networkParams.version||"0"),"residual_3k"===r.network?this.networkParams={name:"residual_3k_3x",tag:"general",version:"2.1"}:"residual_5k"===r.network&&(this.networkParams={name:"residual_5k_3x",tag:"general",version:"0"}),console.log(`Loading Upscaling network ${this.networkParams.name} - tag - ${this.networkParams.tag}  - version ${this.networkParams.version}`),this.glHandle=new class{constructor(e){this.worker=new o,this.id=e.id||(0,i.v4)()}getParameters(e,t,r,i){const{retValP:n}=this.sendMessageToWorker("getParameters",{name:e,tag:t,version:r,token:i});return n}getNetwork(e,t){const{retValP:r}=this.sendMessageToWorker("getNetwork",{name:e,token:t});return r}initWebGLContext(e,t){const{retValP:r}=this.sendMessageToWorker("initWebGLContext",{canvas:e,options:t},[e]);return r}initRenderer(e){const{retValP:t}=this.sendMessageToWorker("initRenderer",{renderInputSize:e});return t}setRenderSize(e){const{retValP:t}=this.sendMessageToWorker("setRenderSize",{renderInputSize:e});return t}setInputSize(e){const{retValP:t}=this.sendMessageToWorker("setInputSize",{inputSize:e});return t}instantiateNetwork(e){const{retValP:t}=this.sendMessageToWorker("instantiateNetwork",{networkOptions:e});return t}changeNetwork(e){const{retValP:t}=this.sendMessageToWorker("changeNetwork",{networkOptions:e});return t}updateOptions(e){const{retValP:t}=this.sendMessageToWorker("updateOptions",{update:e});return t}async _getImageCapture(e){let t;if(e instanceof MediaStream)t=e;else{if(!(e instanceof HTMLVideoElement))throw new Error(`input in _getImageCapture is neither MediaStream nor HTMLVideoElement: ${e}`);t=e.captureStream()}const[r]=t.getVideoTracks();return console.log("In _getImageCapture",r),new ImageCapture(r)}async _setInput(e){console.log("imageCapInstance",this.imageCapInstance),this.imageCapInstance=await this._getImageCapture(e)}async render(){if(!this.imageCapInstance)return!1;try{const e=await this.imageCapInstance.grabFrame(),{retValP:t}=this.sendMessageToWorker("render",{inputImage:e},[e]);return t}catch(e){return!1}}sendMessageToWorker(e,t,r=[]){"render"!==e&&console.log("sendMessageToWorker",e,t,r);const n=(0,i.v4)(),s=this.getWorkerMessage(e,n);return this.worker.postMessage({cmd:e,msgId:n,params:t},r),{msgId:n,retValP:s}}async getWorkerMessage(e,t){const r=this.worker;return new Promise(((i,n)=>{const s="w-"+e,o=new AbortController;r.addEventListener("message",(r=>{if("render"!==e&&console.log("Message event",r),r.data.cmd===s&&r.data.msgId===t){if("render"!==e&&console.log("Aborting",r.data),r.data.ret&&r.data.ret.error)n(r.data.ret.error);else{const t=void 0===r.data.ret||r.data.ret;"render"!==e&&console.log("resolving",r.data,t),i(t)}o.abort()}}),{signal:o.signal})}))}}({id:this.id});const{canvas:n,offscreen:s}=this.initCanvas();this.canvas=n,this.offscreen=s,this.instantiateP=this.instantiateNetwork(),this.setupMetrics(),this.initEvents(),this.reqHandle={noDelay:!1,useRAF:!("requestVideoFrameCallback"in HTMLVideoElement.prototype)},this.reqHandle.noDelay=!0,this.enable(),this.isPlaying=!1,this.playerInitTime=Date.now(),this.initialized=this.initializeNetwork(e),this.error=null,this.analyticsEnabled=!1!==r.analyticsEnabled,this.debug=!0===r.debug,this.debugRender=!0===r.debugRender,this.initAnalytics()}async initAnalytics(){!0===this.analyticsEnabled&&(await Promise.resolve().then(r.t.bind(r,374,23)),window.upscaler_version="v"+l.i8||0,analytics.identify({userId:this.id,traits:{model_token:this.token,upscaler_version:window.upscaler_version,player_init_time:this.playerInitTime,video_duration:this.video.duration,autoplay:this.video.autoplay,renderSize:this.metrics.renderSize,originalSize:this.metrics.originalSize,upscaleFactor:this.metrics.upscaleFactor}}),this.eventList.forEach((e=>{document.addEventListener("vectorly-upscaler-"+e,this.trackEventListener(e))})))}trackEventListener(e){return()=>{this.debug&&console.log("TrackEventListener",e),this.trackAnalytics(e+" Event",{upscale:this.enabled,type:this.events[e].type,currentTime:this.video.currentTime})}}trackAnalytics(e,t){if(this.debug&&console.log("Tracking",e,t),!0===this.analyticsEnabled){let r={timestamp:Date.now()};r={...r,...t},analytics.track(e,{anonymousId:this.id,properties:r})}}updateStream(e){this.stream=e,this.glHandle._setInput(this.stream)}setupMetrics(){this.prv=performance.now(),this.frames={rendered:{sinceTimestamp:0,total:0},video:{total:0}},this.metrics={renderSize:{w:1278,h:720},originalSize:{w:this.video.videoWidth,h:this.video.videoHeight},upscaleFactor:this.scale,droppedFrames:0,fps:0,upscaledFrames:0,videoFrames:0}}async changeNetwork(e){this.debug&&console.log("Changing network from",this.networkParams,"to",e),this.networkParams.name=e.name||this.networkParams.name,this.networkParams.tag=e.tag||this.networkParams.tag,this.networkParams.version=e.version||this.networkParams.version;const t=await(0,h.re)(this.networkParams,this.token,this.serverType);try{const e=this.glHandle.getParameters(this.networkParams.name,this.networkParams.tag,this.networkParams.version,t);this.NetworkClass=await this.glHandle.getNetwork(this.networkParams.name,t),this.networkParameters=await e,await this.glHandle.changeNetwork(this.networkOptions),this.renderSize&&this.setRenderSize(this.renderSize),this.render()}catch(e){console.error("Error fetching network parameters and model or changing model",e),document.dispatchEvent(this.events.error),this.disable()}}async instantiateNetwork(){const e=await(0,h.re)(this.networkParams,this.token,this.serverType);try{const t=this.glHandle.getParameters(this.networkParams.name,this.networkParams.tag,this.networkParams.version,e);this.NetworkClass=await this.glHandle.getNetwork(this.networkParams.name,e),this.networkParameters=await t,this.container?this.container.insertBefore(this.canvas,this.video.nextSibling):document.body.appendChild(this.canvas)}catch(e){throw console.error("Error in instantiateNetwork",e),document.dispatchEvent(this.events.error),this.initialized=!1,this.error=e,this.disable(),e}}disable(){const e=this.video;e.style.height="100%",e.style.width="100%",this.canvas.style.visibility="hidden",e.style.visibility="visible",this.enabled=!1,this.trackAnalytics("Disabled",{upscale:this.enabled})}enable(){this.video.style.visibility="hidden",this.canvas.style.visibility="hidden",this.enabled=!0,console.log("isPlaying",(0,h.yA)(this.video)),(0,h.yA)(this.video)&&this.render(),this.trackAnalytics("Enabled",{upscale:this.enabled})}initEvents(){const e={};this.eventList=["load","error","stop","start"],this.eventList.forEach((function(t){e[t]=new Event("vectorly-upscaler-"+t)})),this.events=e}on(e,t){return document.addEventListener("vectorly-upscaler-"+e,t),this}getResizeObserver(e){return new a.Z((t=>{for(const r of t){const{width:t,height:i}=r.contentRect;e({w:t,h:i})}}))}setRenderSize(e){let t=this.renderSize;this.debug&&console.log("Setting renderSize","w",e.w,"h",e.h),this.renderSize=e;const r=this.canvas;if(this.videoSize&&this.fixaspectratio){this.debug&&console.log("video",this.videoSize,"size",e);let t=this.videoSize.width/this.videoSize.height,r={},i={top:0,left:0,w:e.w,h:e.h};r.w=Math.round(e.h*t),r.h=Math.round(e.w/t),this.debug&&console.log("Expected w h",{w:r.w,h:e.h},{w:e.w,h:r.h}),r.w>e.w?(i.w=e.w,i.h=r.h,i.top=(e.h-i.h)/2):r.h>e.h&&(i.w=r.w,i.h=e.h,i.left=(e.w-i.w)/2),this.margin={left:Math.round(i.left),top:Math.round(i.top)},this.renderInputSize={w:i.w,h:i.h},this.metrics.renderSize=this.renderInputSize,this.debug&&console.log("this.margin",this.margin)}else this.renderInputSize=this.renderSize;console.log("===== IN setRenderSize",this.renderInputSize,this.renderSize,this.renderer),this.renderCanvas&&(this.renderCanvas.width=this.renderInputSize.w,this.renderCanvas.height=this.renderInputSize.h),this.renderer&&(this.glHandle.setRenderSize(this.renderInputSize),r.style.left=`${this.margin.left}px`,r.style.top=`${this.margin.top}px`,this.initialRender(),this.initRenderLoop(),this.trackAnalytics("Render Resize",{renderSize:this.metrics.renderSize,previousRenderSize:t}))}setVideoSize(e){this.debug&&console.log("Setting videoSize to",e,"from",this.videoSize);let t=!1;if(this.videoSize){let r={currentSrc:this.video.currentSrc!==this.videoSrc.currentSrc,srcObject:this.video.srcObject!==this.videoSrc.srcObject};r.currentSrc||r.srcObject?(this.videoSrc={currentSrc:this.video.currentSrc,srcObject:this.video.srcObject},this.reqHandle=this.reqHandle||{},this.reqHandle.useRAF=!0,t=!0):t=e.width!==this.videoSize.width||e.height!==this.videoSize.height}else this.videoSrc={currentSrc:this.video.currentSrc,srcObject:this.video.srcObject},t=!0;if(t){const t=this.inputChangePreHook({before:this.videoSize,after:e},this);this.videoSize=e,this.trackAnalytics("Video Resize",{videoSize:e,previousVideoSize:this.videoSize,resizedProcessed:t}),t?(this.inputSize={w:e.width,h:e.height},this.renderer&&this.glHandle.setInputSize(this.inputSize),this.renderSize&&this.setRenderSize(this.renderSize)):(console.log("not changing as Prehook for inputChange returned",t),this.disable())}}async initializeNetwork(e){try{this.debug&&console.log("Waiting for",this.canvas.id);let t=(0,h.br)("canvas#"+this.canvas.id),r=(0,h.uF)(e);await Promise.all([t,r,this.instantiateP]),this.debug&&console.log("Found canvas ",this.canvas.id);const i=await r;return this.setVideoSize(i),e.addEventListener("resize",(()=>{this.setVideoSize({width:e.videoWidth,height:e.videoHeight}),this.metrics.originalSize={w:e.videoWidth,h:e.videoHeight},e.requestVideoFrameCallback&&e.requestVideoFrameCallback(function(){this.renderAFrame()}.bind(this))})),this.renderSize=this.renderSize||{w:1278,h:720},this.setRenderSize(this.renderSize),this.initializeWebGL(),!0}catch(e){return this.error=e,!1}}async renderAFrame(){const e=await this.glHandle.render();return!!e&&(this.renderContext&&this.renderContext.drawImage(e.bitmap,0,0),!0)}async initializeWebGL(){this.debug&&console.log("Initializing WebGL context and network",this.inputSize,this.renderInputSize);try{this.gl=await this.glHandle.initWebGLContext(this.offscreen,{h:this.inputSize.h,w:this.inputSize.w,use_webgl1:this.use_webgl1,float_type:this.float_type}),this.debug&&console.log("this.gl initialized",this.gl.input),console.log("this.gl initialized",this.gl.input)}catch(e){this.gl=null}this.gl?(this.initialized=this.glHandle.instantiateNetwork(this.networkOptions),this.frameBuffer=await this.initialized,this.renderer=await this.glHandle.initRenderer(this.renderInputSize),console.log("this.renderer",this.renderer),this.canvas.style.left=`${this.margin.left}px`,this.canvas.style.top=`${this.margin.top}px`,console.log("this.stream",this.stream),this.glHandle._setInput(this.stream),this.initialRender(),this.initVideoEventRender(),this.initRenderLoop()):(document.dispatchEvent(this.events.error),this.disable())}initRenderLoop(){const e=this.video;(0,h.yA)(this.video)&&this.render(),e.addEventListener("play",function(){this.render()}.bind(this)),document.dispatchEvent(this.events.load)}initialRender(){const e=this.video;this.debug&&console.log("Calling Initial Render"),4===e.readyState&&setTimeout((()=>{this.renderAFrame()}),100),e.requestVideoFrameCallback&&e.requestVideoFrameCallback(function(){if((0,h.yA)(e))return null;this.renderAFrame()}.bind(this))}initVideoEventRender(){const e=this.video;e.oncanplaythrough=function(){this.renderAFrame()}.bind(this),e.onloadeddata=function(){this.renderAFrame()}.bind(this)}updateFrameMetrics(){if(this.frames.rendered.total++,this.frames.rendered.sinceTimestamp++,this.metrics.upscaledFrames++,performance.now()-this.prv>5e3){this.metrics.fps=JSON.parse(JSON.stringify(this.frames.rendered.sinceTimestamp))/5,this.prv=performance.now(),this.frames.rendered.sinceTimestamp=0;const e=this.video;let t=e.webkitDecodedFrameCount||e.mozPresentedFrames||e.decodedFrames||e.presentedFrames;t&&(this.frames.video.total=t,this.metrics.videoFrames=t,this.metrics.droppedFrames=this.metrics.videoFrames-this.metrics.upscaledFrames,this.debug&&console.log(`currentTime: ${this.video.currentTime}, FPS: ${this.metrics.fps}, Dropped frames: ${this.metrics.droppedFrames}, Video Frame: ${this.metrics.videoFrames}, Rendered frames: ${this.metrics.upscaledFrames}`),this.trackAnalytics("Playback Metrics",{FPS:this.metrics.fps,droppedFrames:this.metrics.droppedFrames,videoFrames:this.metrics.videoFrames,upscaledFrames:this.metrics.upscaledFrames,currentTime:this.video.currentTime}))}}async renderVideoFrame(e){try{if(this.debugRender&&console.log("Calling renderVideoFrame in a loop",e),this.video&&this.frameBuffer&&this.renderer){const e=await this.renderAFrame();if(e&&this.updateFrameMetrics(),this.reqHandle.noDelay)return this.enabled?e?void await this.renderVideoFrame():void setTimeout((()=>this.renderVideoFrame()),30):void document.dispatchEvent(this.events.stop)}(0,h.yA)(this.video)&&this.enabled?(this.debugRender&&console.log("calling requestFrame"),this.requestFrame(this.video,this.renderVideoFrame.bind(this)),this.isPlaying=!0):(this.debugRender&&console.log("STOPPED playing"),document.dispatchEvent(this.events.stop),this.isPlaying=!1)}catch(e){console.error("Error in renderVideoFrame",e)}}requestFrame(e,t){if(this.reqHandle=this.reqHandle||{},this.reqHandle.useRAF){let e=(0,c.U7)(t);this.reqHandle.raf=e}else{let r=e.requestVideoFrameCallback(t);this.reqHandle.video=e,this.reqHandle.rfvc=r}}async updateNetworkOptions(e){await this.glHandle.updateOptions(e)}cancelLastRender(){if(this.debugRender&&console.log("Canceling last render"),this.reqHandle=this.reqHandle||{},this.reqHandle.rfvc){let{video:e,rfvc:t}=this.reqHandle;e.cancelVideoFrameCallback(t),this.reqHandle.rfvc=null}if(this.reqHandle.raf){let{raf:e}=this.reqHandle;(0,c.Wx)(e),this.reqHandle.raf=null}}render(){this.renderCaller=(this.renderCaller||0)+1,this.debugRender&&console.log("Starting render call with isPlaying",this.isPlaying),this.prv=performance.now(),this.cancelLastRender(),this.renderVideoFrame(`my-render-${this.renderCaller}`),document.dispatchEvent(this.events.start)}initCanvas(){let e=document.createElement("canvas");e.id="canv-"+this.id,e.style.position="absolute",e.style.left=this.margin.left,e.style.top=this.margin.top;let t=document.createElement("canvas");this.renderContext=t.getContext("2d"),this.renderCanvas=t,window.upscalers=window.upscalers||{},window.upscalers[e.id]=this;const r=e.transferControlToOffscreen();return{canvas:e,offscreen:r}}}},374:function(){!function(){var e=window.analytics=window.analytics||[];if(!e.initialize)if(e.invoked)window.console&&console.error&&console.error("Segment snippet included twice.");else{e.invoked=!0,e.methods=["trackSubmit","trackClick","trackLink","trackForm","pageview","identify","reset","group","track","ready","alias","debug","page","once","off","on","addSourceMiddleware","addIntegrationMiddleware","setAnonymousId","addDestinationMiddleware"],e.factory=function(t){return function(){var r=Array.prototype.slice.call(arguments);return r.unshift(t),e.push(r),e}};for(var t=0;t<e.methods.length;t++){var r=e.methods[t];e[r]=e.factory(r)}e.load=function(t,r){var i=document.createElement("script");i.type="text/javascript",i.async=!0,i.src="https://cdn.segment.com/analytics.js/v1/"+t+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(i,n),e._loadOptions=r},e.SNIPPET_VERSION="4.1.0",e.load("QdFatFh8tOtRq6phb4bmBGZa6UOK7E8M"),e.page()}}()},443:function(e,t,r){"use strict";function i(){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope}function n(){return i()?(self.isWorker=!0,self):(window.isWorker=!1,window)}function s(e){return i()?e instanceof OffscreenCanvasRenderingContext2D:e instanceof CanvasRenderingContext2D}r.r(t),r.d(t,{default:function(){return M}});var o=function(e,t){let r;"string"==typeof e&&(e=document.getElementById(e));let i=1;if("true"===t.use_webgl1?(r=e.getContext("webgl"),console.log("Using Webgl 1")):(r=e.getContext("webgl2"),i=2,r?console.log("Using Webgl 2"):(i=1,r=e.getContext("webgl"),console.log("Using Webgl 1"))),r.getExtension("WEBGL_draw_buffers")?r.disable_multi_draw=t.disable_multi_draw||!1:r.disable_multi_draw=!0,r.extensions={},r.getVersion=function(){return i},1===r.getVersion()){if("float32"===t.float_type){if(r.extensions.EXT_FLOAT=r.getExtension("OES_texture_float"),!r.extensions.EXT_FLOAT)throw new Error("Extension not found: OES_texture_float");r.extensions.EXT_FLOAT_LINEAR=r.getExtension("OES_texture_float_linear"),r.extensions.EXT_FLOAT_LINEAR||console.warn("Extension not found: OES_texture_float_linear"),r.texture_format=r.RGBA,r.texture_type=r.FLOAT}else{if(r.extensions.EXT_FLOAT=r.getExtension("OES_texture_half_float"),!r.extensions.EXT_FLOAT)throw new Error("Extension not found: OES_texture_half_float");r.extensions.EXT_FLOAT_LINEAR=r.getExtension("OES_texture_half_float_linear"),r.extensions.EXT_FLOAT_LINEAR||console.warn("Extension not found: OES_texture_half_float_linear"),r.texture_format=r.RGBA,r.texture_type=r.extensions.EXT_FLOAT.HALF_FLOAT_OES}if(r.disable_multi_draw)console.log("Multi Draw Disabled");else if(console.log("Multi Draw Enabled"),r.extensions.WEBGL_draw_buffers=r.getExtension("WEBGL_draw_buffers"),!r.extensions.WEBGL_draw_buffers)throw new Error("Extension not found: WEBGL_draw_buffers")}else{if(r.extensions.EXT_FLOAT=r.getExtension("EXT_color_buffer_float"),!r.extensions.EXT_FLOAT)throw new Error("Extension not found: EXT_color_buffer_float");"float32"===t.float_type?(r.extensions.EXT_FLOAT_LINEAR=r.getExtension("OES_texture_float_linear"),r.texture_format=r.RGBA32F,r.texture_type=r.FLOAT):(r.extensions.EXT_FLOAT_LINEAR=r.getExtension("OES_texture_half_float_linear"),r.texture_format=r.RGBA16F,r.texture_type=r.FLOAT)}return console.log(r.texture_format,r.texture_type),1===r.getVersion()?(r.getCOLOR_ATTACHMENT=function(e=0){return r.disable_multi_draw?(e>0&&console.warn("Slot cannot be greater than 0 when multi draw is disabled"),r.COLOR_ATTACHMENT0):r.extensions.WEBGL_draw_buffers.COLOR_ATTACHMENT0_WEBGL+e},r.getDrawBuffers=function(e=[r.getCOLOR_ATTACHMENT(0)]){r.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(e)}):(r.getCOLOR_ATTACHMENT=function(e=0){return r.COLOR_ATTACHMENT0+e},r.getDrawBuffers=function(e=[r.getCOLOR_ATTACHMENT(0)]){r.drawBuffers(e)}),n().gl=r,r||console.log("WebGL Not Supported"),r.canvas.w=r.canvas.width,r.canvas.h=r.canvas.height,r.clearCanvas=function(){r.clearColor(0,0,0,1),r.viewport(0,0,r.drawingBufferWidth,r.drawingBufferHeight),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT|r.STENCIL_BUFFER_BIT)},r.input={h:t.h,w:t.w},r.render_scale={h:1,w:1},r.viewport(0,0,e.width,e.height),r.createAndCompileShader=function(e,t){let i=r.createShader(e);if(r.shaderSource(i,t),r.compileShader(i),!r.getShaderParameter(i,r.COMPILE_STATUS))throw new Error(r.getShaderInfoLog(i));return i},r.createAndLinkProgram=function(e,t){let i=r.createProgram();if(r.attachShader(i,e),r.attachShader(i,t),r.linkProgram(i),!r.getProgramParameter(i,r.LINK_STATUS))throw new Error(r.getProgramInfoLog(i));return i},r.resizeCanvasToDisplaySize=function(t,r){return(e.width!==t||e.height!==r)&&(e.width=t,e.height=r,!0)},r.resizeRenderSize=function(e,t,i){let n=i*r.input.w,s=i*r.input.h;n=e>n?e:n,s=t>s?t:s,r.render_scale={w:e/n,h:t/s},r.resizeCanvasToDisplaySize(n,s)},r};r(435);var a="undefined"!=typeof globalThis&&globalThis||"undefined"!=typeof self&&self||void 0!==a&&a,h="URLSearchParams"in a,l="Symbol"in a&&"iterator"in Symbol,c="FileReader"in a&&"Blob"in a&&function(){try{return new Blob,!0}catch(e){return!1}}(),d="FormData"in a,u="ArrayBuffer"in a;if(u)var f=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],p=ArrayBuffer.isView||function(e){return e&&f.indexOf(Object.prototype.toString.call(e))>-1};function g(e){if("string"!=typeof e&&(e=String(e)),/[^a-z0-9\-#$%&'*+.^_`|~!]/i.test(e)||""===e)throw new TypeError('Invalid character in header field name: "'+e+'"');return e.toLowerCase()}function m(e){return"string"!=typeof e&&(e=String(e)),e}function w(e){var t={next:function(){var t=e.shift();return{done:void 0===t,value:t}}};return l&&(t[Symbol.iterator]=function(){return t}),t}function y(e){this.map={},e instanceof y?e.forEach((function(e,t){this.append(t,e)}),this):Array.isArray(e)?e.forEach((function(e){this.append(e[0],e[1])}),this):e&&Object.getOwnPropertyNames(e).forEach((function(t){this.append(t,e[t])}),this)}function v(e){if(e.bodyUsed)return Promise.reject(new TypeError("Already read"));e.bodyUsed=!0}function b(e){return new Promise((function(t,r){e.onload=function(){t(e.result)},e.onerror=function(){r(e.error)}}))}function _(e){var t=new FileReader,r=b(t);return t.readAsArrayBuffer(e),r}function E(e){if(e.slice)return e.slice(0);var t=new Uint8Array(e.byteLength);return t.set(new Uint8Array(e)),t.buffer}function T(){return this.bodyUsed=!1,this._initBody=function(e){var t;this.bodyUsed=this.bodyUsed,this._bodyInit=e,e?"string"==typeof e?this._bodyText=e:c&&Blob.prototype.isPrototypeOf(e)?this._bodyBlob=e:d&&FormData.prototype.isPrototypeOf(e)?this._bodyFormData=e:h&&URLSearchParams.prototype.isPrototypeOf(e)?this._bodyText=e.toString():u&&c&&(t=e)&&DataView.prototype.isPrototypeOf(t)?(this._bodyArrayBuffer=E(e.buffer),this._bodyInit=new Blob([this._bodyArrayBuffer])):u&&(ArrayBuffer.prototype.isPrototypeOf(e)||p(e))?this._bodyArrayBuffer=E(e):this._bodyText=e=Object.prototype.toString.call(e):this._bodyText="",this.headers.get("content-type")||("string"==typeof e?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):h&&URLSearchParams.prototype.isPrototypeOf(e)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))},c&&(this.blob=function(){var e=v(this);if(e)return e;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))},this.arrayBuffer=function(){return this._bodyArrayBuffer?v(this)||(ArrayBuffer.isView(this._bodyArrayBuffer)?Promise.resolve(this._bodyArrayBuffer.buffer.slice(this._bodyArrayBuffer.byteOffset,this._bodyArrayBuffer.byteOffset+this._bodyArrayBuffer.byteLength)):Promise.resolve(this._bodyArrayBuffer)):this.blob().then(_)}),this.text=function(){var e,t,r,i=v(this);if(i)return i;if(this._bodyBlob)return e=this._bodyBlob,r=b(t=new FileReader),t.readAsText(e),r;if(this._bodyArrayBuffer)return Promise.resolve(function(e){for(var t=new Uint8Array(e),r=new Array(t.length),i=0;i<t.length;i++)r[i]=String.fromCharCode(t[i]);return r.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)},d&&(this.formData=function(){return this.text().then(S)}),this.json=function(){return this.text().then(JSON.parse)},this}y.prototype.append=function(e,t){e=g(e),t=m(t);var r=this.map[e];this.map[e]=r?r+", "+t:t},y.prototype.delete=function(e){delete this.map[g(e)]},y.prototype.get=function(e){return e=g(e),this.has(e)?this.map[e]:null},y.prototype.has=function(e){return this.map.hasOwnProperty(g(e))},y.prototype.set=function(e,t){this.map[g(e)]=m(t)},y.prototype.forEach=function(e,t){for(var r in this.map)this.map.hasOwnProperty(r)&&e.call(t,this.map[r],r,this)},y.prototype.keys=function(){var e=[];return this.forEach((function(t,r){e.push(r)})),w(e)},y.prototype.values=function(){var e=[];return this.forEach((function(t){e.push(t)})),w(e)},y.prototype.entries=function(){var e=[];return this.forEach((function(t,r){e.push([r,t])})),w(e)},l&&(y.prototype[Symbol.iterator]=y.prototype.entries);var k=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];function x(e,t){if(!(this instanceof x))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');var r,i,n=(t=t||{}).body;if(e instanceof x){if(e.bodyUsed)throw new TypeError("Already read");this.url=e.url,this.credentials=e.credentials,t.headers||(this.headers=new y(e.headers)),this.method=e.method,this.mode=e.mode,this.signal=e.signal,n||null==e._bodyInit||(n=e._bodyInit,e.bodyUsed=!0)}else this.url=String(e);if(this.credentials=t.credentials||this.credentials||"same-origin",!t.headers&&this.headers||(this.headers=new y(t.headers)),this.method=(i=(r=t.method||this.method||"GET").toUpperCase(),k.indexOf(i)>-1?i:r),this.mode=t.mode||this.mode||null,this.signal=t.signal||this.signal,this.referrer=null,("GET"===this.method||"HEAD"===this.method)&&n)throw new TypeError("Body not allowed for GET or HEAD requests");if(this._initBody(n),!("GET"!==this.method&&"HEAD"!==this.method||"no-store"!==t.cache&&"no-cache"!==t.cache)){var s=/([?&])_=[^&]*/;s.test(this.url)?this.url=this.url.replace(s,"$1_="+(new Date).getTime()):this.url+=(/\?/.test(this.url)?"&":"?")+"_="+(new Date).getTime()}}function S(e){var t=new FormData;return e.trim().split("&").forEach((function(e){if(e){var r=e.split("="),i=r.shift().replace(/\+/g," "),n=r.join("=").replace(/\+/g," ");t.append(decodeURIComponent(i),decodeURIComponent(n))}})),t}function R(e,t){if(!(this instanceof R))throw new TypeError('Please use the "new" operator, this DOM object constructor cannot be called as a function.');t||(t={}),this.type="default",this.status=void 0===t.status?200:t.status,this.ok=this.status>=200&&this.status<300,this.statusText=void 0===t.statusText?"":""+t.statusText,this.headers=new y(t.headers),this.url=t.url||"",this._initBody(e)}x.prototype.clone=function(){return new x(this,{body:this._bodyInit})},T.call(x.prototype),T.call(R.prototype),R.prototype.clone=function(){return new R(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new y(this.headers),url:this.url})},R.error=function(){var e=new R(null,{status:0,statusText:""});return e.type="error",e};var A=[301,302,303,307,308];R.redirect=function(e,t){if(-1===A.indexOf(t))throw new RangeError("Invalid status code");return new R(null,{status:t,headers:{location:e}})};var P=a.DOMException;try{new P}catch(e){(P=function(e,t){this.message=e,this.name=t;var r=Error(e);this.stack=r.stack}).prototype=Object.create(Error.prototype),P.prototype.constructor=P}function O(e,t){return new Promise((function(r,i){var n=new x(e,t);if(n.signal&&n.signal.aborted)return i(new P("Aborted","AbortError"));var s=new XMLHttpRequest;function o(){s.abort()}s.onload=function(){var e,t,i={status:s.status,statusText:s.statusText,headers:(e=s.getAllResponseHeaders()||"",t=new y,e.replace(/\r?\n[\t ]+/g," ").split("\r").map((function(e){return 0===e.indexOf("\n")?e.substr(1,e.length):e})).forEach((function(e){var r=e.split(":"),i=r.shift().trim();if(i){var n=r.join(":").trim();t.append(i,n)}})),t)};i.url="responseURL"in s?s.responseURL:i.headers.get("X-Request-URL");var n="response"in s?s.response:s.responseText;setTimeout((function(){r(new R(n,i))}),0)},s.onerror=function(){setTimeout((function(){i(new TypeError("Network request failed"))}),0)},s.ontimeout=function(){setTimeout((function(){i(new TypeError("Network request failed"))}),0)},s.onabort=function(){setTimeout((function(){i(new P("Aborted","AbortError"))}),0)},s.open(n.method,function(e){try{return""===e&&a.location.href?a.location.href:e}catch(t){return e}}(n.url),!0),"include"===n.credentials?s.withCredentials=!0:"omit"===n.credentials&&(s.withCredentials=!1),"responseType"in s&&(c?s.responseType="blob":u&&n.headers.get("Content-Type")&&-1!==n.headers.get("Content-Type").indexOf("application/octet-stream")&&(s.responseType="arraybuffer")),!t||"object"!=typeof t.headers||t.headers instanceof y?n.headers.forEach((function(e,t){s.setRequestHeader(t,e)})):Object.getOwnPropertyNames(t.headers).forEach((function(e){s.setRequestHeader(e,m(t.headers[e]))})),n.signal&&(n.signal.addEventListener("abort",o),s.onreadystatechange=function(){4===s.readyState&&n.signal.removeEventListener("abort",o)}),s.send(void 0===n._bodyInit?null:n._bodyInit)}))}O.polyfill=!0,a.fetch||(a.fetch=O,a.Headers=y,a.Request=x,a.Response=R);let F=async(e,t={})=>{let i=((t=t||{}).path||r.p)+`models/${e}.js`;console.log(i),t.token&&(i=i+"?"+t.token);let s=n();var o;return s.isWorker?importScripts(i):await(o=i,new Promise(((e,t)=>{const r="$importModule$"+Math.random().toString(32).slice(2),i=document.createElement("script"),n=()=>{delete window[r],i.onerror=null,i.onload=null,i.remove(),URL.revokeObjectURL(i.src),i.src=""};i.defer="defer",i.type="module",i.onerror=()=>{t(new Error(`Failed to import: ${o}`)),n()},i.onload=()=>{e(window[r]),n()};const s=function(e){const t=document.createElement("a");return t.setAttribute("href",e),t.cloneNode(!1).href}(o),a=new Blob([`import * as m from "${s}"; window.${r} = m;`],{type:"text/javascript"});i.src=URL.createObjectURL(a),document.head.appendChild(i)}))),s.vectorlyBasePath=t.path||r.p,s.vectorly.models[e]},C=async(e,t,i,n)=>{if(n=n||{},"background_meet"===e){let s=(n.path||r.p)+`./data/${e}/${t}_v${i}.tflite`;n.token&&(s=s+"?"+n.token);const o=await fetch(s);if(!o.ok)throw Error(`Response fetching "${s}": ${o.statusText}`);return{model:await o.arrayBuffer()}}{let s=(n.path||r.p)+`./data/${e}/${t}_v${i}.json`;n.token&&(s=s+"?"+n.token);const o=await fetch(s);return await o.json()}};var B=r(33),z=r(8),L=r(877),I=r(306),U=r(820),M=class{constructor(e,t){console.log("Initialized upscaler with",e);const r=t;this.video=e,this.id=r.id||(0,L.v4)(),this.videoParent=e.parentNode,this.token=r.token,this.serverType=r.serverType,this.fixaspectratio=r.fixaspectratio||!0,this.inputChangePreHook=r.inputChangePreHook||(()=>!0),this.renderSize=r.renderSize,"disable"===r.container?this.container=null:this.container=r.container||e.parentNode,console.log("Container is",this.container),this.container&&(this.container.style.background="black",this.container.style.resize="both",this.container.style.overflow="hidden",this.ro=this.getResizeObserver(this.setRenderSize.bind(this)),this.ro.observe(this.container)),this.margin={top:0,left:0},this.use_webgl1=r.use_webgl1||"false",this.float_type=r.float_type||"float16",this.scale=r.scale||3,r.networkParams=r.networkParams||{},this.networkParams={name:"residual_3k_3x",tag:"general",version:"2.1"},this.networkParams=Object.assign(this.networkParams,r.networkParams),this.networkOptions=r.networkOptions||{},(r.network||r.tag||r.version)&&(this.networkParams.name=r.network||this.networkParams.name,this.networkParams.tag=r.tag||this.networkParams.tag,"residual_3k_3x"===this.networkParams.name?this.networkParams.version=r.version||r.networkParams.version||"2.1":this.networkParams.version=r.version||r.networkParams.version||"0"),"residual_3k"===r.network?this.networkParams={name:"residual_3k_3x",tag:"general",version:"2.1"}:"residual_5k"===r.network&&(this.networkParams={name:"residual_5k_3x",tag:"general",version:"0"}),console.log(`Loading Upscaling network ${this.networkParams.name} - tag - ${this.networkParams.tag}  - version ${this.networkParams.version}`),this.canvas=this.initCanvas(),this.instantiateP=this.instantiateNetwork(),this.setupMetrics(),this.initEvents(),this.reqHandle={useRAF:!("requestVideoFrameCallback"in HTMLVideoElement.prototype)},this.enable(),this.isPlaying=!1,this.playerInitTime=Date.now(),this.initialized=this.initializeNetwork(e),this.error=null,this.analyticsEnabled=!1!==r.analyticsEnabled,this.debug=!0===r.debug,this.debugRender=!0===r.debugRender,this.initAnalytics()}async initAnalytics(){!0===this.analyticsEnabled&&(await Promise.resolve().then(r.t.bind(r,374,23)),window.upscaler_version="v"+I.i8||0,analytics.identify({userId:this.id,traits:{model_token:this.token,upscaler_version:window.upscaler_version,player_init_time:this.playerInitTime,video_duration:this.video.duration,autoplay:this.video.autoplay,renderSize:this.metrics.renderSize,originalSize:this.metrics.originalSize,upscaleFactor:this.metrics.upscaleFactor}}),this.eventList.forEach((e=>{document.addEventListener("vectorly-upscaler-"+e,this.trackEventListener(e))})))}trackEventListener(e){return()=>{this.debug&&console.log("TrackEventListener",e),this.trackAnalytics(e+" Event",{upscale:this.enabled,type:this.events[e].type,currentTime:this.video.currentTime})}}trackAnalytics(e,t){if(this.debug&&console.log("Tracking",e,t),!0===this.analyticsEnabled){let r={timestamp:Date.now()};r={...r,...t},analytics.track(e,{anonymousId:this.id,properties:r})}}setupMetrics(){this.prv=performance.now(),this.frames={rendered:{sinceTimestamp:0,total:0},video:{total:0}},this.metrics={renderSize:{w:1278,h:720},originalSize:{w:this.video.videoWidth,h:this.video.videoHeight},upscaleFactor:this.scale,droppedFrames:0,fps:0,upscaledFrames:0,videoFrames:0}}async changeNetwork(e){this.debug&&console.log("Changing network from",this.networkParams,"to",e),this.networkParams.name=e.name||this.networkParams.name,this.networkParams.tag=e.tag||this.networkParams.tag,this.networkParams.version=e.version||this.networkParams.version;const t=await(0,z.re)(this.networkParams,this.token,this.serverType);try{const e=C(this.networkParams.name,this.networkParams.tag,this.networkParams.version,t);this.NetworkClass=await F(this.networkParams.name,t),this.networkParameters=await e,this.frameBuffer.clearall(),this.networkInstance=new this.NetworkClass(this.gl,this.frameBuffer,this.networkParameters,this.networkOptions),this.renderer.changeNetwork(this.networkInstance),this.renderSize&&this.setRenderSize(this.renderSize),this.render()}catch(e){console.error("Error fetching network parameters and model or changing model",e),document.dispatchEvent(this.events.error),this.disable()}}async instantiateNetwork(){const e=await(0,z.re)(this.networkParams,this.token,this.serverType);try{const t=C(this.networkParams.name,this.networkParams.tag,this.networkParams.version,e);this.NetworkClass=await F(this.networkParams.name,e),this.networkParameters=await t,this.container?this.container.insertBefore(this.canvas,this.video.nextSibling):document.body.appendChild(this.canvas)}catch(e){throw console.error("Error in instantiateNetwork",e),document.dispatchEvent(this.events.error),this.initialized=!1,this.error=e,this.disable(),e}}disable(){const e=this.video;e.style.height="100%",e.style.width="100%",this.canvas.style.visibility="hidden",e.style.visibility="visible",this.enabled=!1,this.trackAnalytics("Disabled",{upscale:this.enabled})}enable(){this.video.style.visibility="hidden",this.canvas.style.visibility="visible",this.enabled=!0,(0,z.yA)(this.video)&&this.render(),this.trackAnalytics("Enabled",{upscale:this.enabled})}initEvents(){const e={};this.eventList=["load","error","stop","start"],this.eventList.forEach((function(t){e[t]=new Event("vectorly-upscaler-"+t)})),this.events=e}on(e,t){return document.addEventListener("vectorly-upscaler-"+e,t),this}getResizeObserver(e){return new B.Z((t=>{for(const r of t){const{width:t,height:i}=r.contentRect;e({w:t,h:i})}}))}setRenderSize(e){let t=this.renderSize;this.debug&&console.log("Setting renderSize","w",e.w,"h",e.h),this.renderSize=e;const r=this.canvas;if(this.videoSize&&this.fixaspectratio){this.debug&&console.log("video",this.videoSize,"size",e);let t=this.videoSize.width/this.videoSize.height,r={},i={top:0,left:0,w:e.w,h:e.h};r.w=Math.round(e.h*t),r.h=Math.round(e.w/t),this.debug&&console.log("Expected w h",{w:r.w,h:e.h},{w:e.w,h:r.h}),r.w>e.w?(i.w=e.w,i.h=r.h,i.top=(e.h-i.h)/2):r.h>e.h&&(i.w=r.w,i.h=e.h,i.left=(e.w-i.w)/2),this.margin={left:Math.round(i.left),top:Math.round(i.top)},this.renderInputSize={w:i.w,h:i.h},this.metrics.renderSize=this.renderInputSize,this.debug&&console.log("this.margin",this.margin)}else this.renderInputSize=this.renderSize;console.log("===== IN setRenderSize",this.renderInputSize,this.renderSize,this.renderer),this.renderer&&(this.renderer.setProperties(this.renderInputSize),r.style.left=`${this.margin.left}px`,r.style.top=`${this.margin.top}px`,this.initialRender(),this.initRenderLoop(),this.trackAnalytics("Render Resize",{renderSize:this.metrics.renderSize,previousRenderSize:t}))}setVideoSize(e){this.debug&&console.log("Setting videoSize to",e,"from",this.videoSize);let t=!1;if(this.videoSize){let r={currentSrc:this.video.currentSrc!==this.videoSrc.currentSrc,srcObject:this.video.srcObject!==this.videoSrc.srcObject};r.currentSrc||r.srcObject?(this.videoSrc={currentSrc:this.video.currentSrc,srcObject:this.video.srcObject},this.reqHandle=this.reqHandle||{},this.reqHandle.useRAF=!0,t=!0):t=e.width!==this.videoSize.width||e.height!==this.videoSize.height}else this.videoSrc={currentSrc:this.video.currentSrc,srcObject:this.video.srcObject},t=!0;if(t){const t=this.inputChangePreHook({before:this.videoSize,after:e},this);this.videoSize=e,this.trackAnalytics("Video Resize",{videoSize:e,previousVideoSize:this.videoSize,resizedProcessed:t}),t?(this.inputSize={w:e.width,h:e.height},this.renderer&&this.renderer.setInputSize(this.inputSize),this.renderSize&&this.setRenderSize(this.renderSize)):(console.log("not changing as Prehook for inputChange returned",t),this.disable())}}async initializeNetwork(e){try{this.debug&&console.log("Waiting for",this.canvas.id);let t=(0,z.br)("canvas#"+this.canvas.id),r=(0,z.uF)(e);await Promise.all([t,r,this.instantiateP]),this.debug&&console.log("Found canvas ",this.canvas.id);const i=await r;return this.setVideoSize(i),e.addEventListener("resize",(()=>{this.setVideoSize({width:e.videoWidth,height:e.videoHeight}),this.metrics.originalSize={w:e.videoWidth,h:e.videoHeight},e.requestVideoFrameCallback&&e.requestVideoFrameCallback(function(){this.renderAFrame()}.bind(this))})),this.renderSize=this.renderSize||{w:1278,h:720},this.setRenderSize(this.renderSize),this.initializeWebGL(),!0}catch(e){return this.error=e,!1}}renderAFrame(){this.frameBuffer&&this.frameBuffer.setInputImage(this.video),this.renderer&&this.renderer.render()}async initializeWebGL(){this.debug&&console.log("Initializing WebGL context and network",this.inputSize,this.renderInputSize);try{this.gl=new o(this.canvas.id,{h:this.inputSize.h,w:this.inputSize.w,use_webgl1:this.use_webgl1,float_type:this.float_type}),this.debug&&console.log("this.gl initialized",this.gl.input),console.log("this.gl initialized",this.gl.input)}catch(e){console.warn("Error in intializing WebGLContext",e),this.gl=null}this.gl?(this.frameBuffer=new class{constructor(e){this.gl=e,this.iterations=0,this.textures=[{},{}],this.frame_buffers=[{},{}],this.inputTex=null,this.inputCanvas=null,this.frame_difference=0}drawToCanvas(){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}setBuffer(e){const t=this.gl,r=this.iterations%2*this.frame_difference;t.bindFramebuffer(t.FRAMEBUFFER,this.frame_buffers[r][e])}setInputFrameCanvas(){console.log("setting up the canvas: "),n(),s(this.inputCanvas)?console.log("Canvas already created"):(this.inputCanvas=function(e,t){if(i())return new OffscreenCanvas(e,t);{const r=document.createElement("canvas");return r.width=e,r.height=t,r}}(this.gl.input.w,this.gl.input.h).getContext("2d"),console.log("canvas creation complete")),console.log("updating the canvas resolution"),this.inputCanvas.canvas.width=this.gl.input.w,this.inputCanvas.canvas.height=this.gl.input.h}videoToCanvas(e){return this.inputCanvas.drawImage(e,0,0,this.gl.input.w,this.gl.input.h),this.inputCanvas.canvas}getInputTexture(){const e=this.gl;return null===this.inputTex&&(this.inputTex=e.createTexture()),this.inputTex}setInputImage(e,t=!1){t=t||!1,this.input=e;const r=this.gl,i=this.getInputTexture();r.bindTexture(r.TEXTURE_2D,i),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.NEAREST),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.NEAREST),s(this.inputCanvas)&&(e=this.videoToCanvas(e)),r.texImage2D(r.TEXTURE_2D,0,r.texture_format,r.RGBA,r.texture_type,e);for(let e=0;e<=this.frame_difference;e++)this.textures[e].INPUT=[i]}createBufferWithTextures(e,t,r=1,i=null){const n=this.gl;for(let s=0;s<=this.frame_difference;s++){const o=n.createFramebuffer();this.frame_buffers[s][e]=o,n.bindFramebuffer(n.FRAMEBUFFER,o);const a=[];this.textures[s][e]=null;for(let e=0;e<t;++e){const t=this.createAndSetupTexture(i);a.push(t),n.bindTexture(n.TEXTURE_2D,t),n.texImage2D(n.TEXTURE_2D,0,n.texture_format,n.input.w*r,n.input.h*r,0,n.RGBA,n.texture_type,null),n.framebufferTexture2D(n.FRAMEBUFFER,n.getCOLOR_ATTACHMENT(e),n.TEXTURE_2D,t,0)}this.textures[s][e]=a}}createTexture_webgl2(e,t,r,i=gl.NEAREST,n=gl.NEAREST){const s=gl.createTexture();return gl.bindTexture(gl.TEXTURE_2D,s),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,i),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,n),gl.texStorage2D(gl.TEXTURE_2D,1,e,t,r),s}createTexture_webgl1(e,t,r,i,n,s=gl.NEAREST,o=gl.NEAREST){const a=gl.createTexture();return gl.bindTexture(gl.TEXTURE_2D,a),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,s),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,o),gl.texImage2D(gl.TEXTURE_2D,0,e,t,r,0,i,n,null),a}setBufferForLayer(e,t){for(let r=0;r<=this.frame_difference;r++){const i=gl.createFramebuffer();this.frame_buffers[r][e]=i,gl.bindFramebuffer(gl.FRAMEBUFFER,i);for(let e=0;e<t.length;e++)gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.getCOLOR_ATTACHMENT(e),gl.TEXTURE_2D,t[e],0);this.textures[r][e]=t}}getTexture(e){const t=this.iterations%2*this.frame_difference;return this.textures[t][e]}getLastFrameTexture(e){const t=1-this.iterations%2;return this.textures[t][e]}clearall(){let e=Object.keys(this.textures[0]);console.log("clearing buffers and textures..."),e.forEach((e=>{for(let t=0;t<=this.frame_difference;t++){this.gl.deleteFramebuffer(this.frame_buffers[t][e]),this.frame_buffers[t][e]=null;for(let r=0;r<this.textures[t][e].length;++r)this.gl.deleteTexture(this.textures[t][e][r]),this.textures[t][e][r]=null}})),this.gl.deleteTexture(this.inputTex),this.inputTex=null,this.inputCanvas=null,this.frame_buffers=[{},{}],this.textures=[{},{}],this.gl.clearCanvas()}createAndSetupTexture(e=null){const t=this.gl;t.extensions.EXT_FLOAT_LINEAR||(e=null),null===e&&(e=t.NEAREST);const r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,e),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),r}}(this.gl),this.networkInstance=new this.NetworkClass(this.gl,this.frameBuffer,this.networkParameters,this.networkOptions),this.initialized=this.networkInstance.initialized,await this.initialized,this.renderer=new class{constructor(e,t,r,i){this.gl=e,this.network=t,this.frameBuffer=r,this.renderSize={w:i.w,h:i.h},this.metrics={"Render Size":this.renderSize,"Original Size":e.input,"Upscale Factor":t.upscaleFactor,FPS:0},this.setProperties(i)}setProperties(e={w:1278,h:720,disableVideoToCanvas:!1}){const t=this;!0!==e.disableVideoToCanvas&&this.frameBuffer.setInputFrameCanvas(),void 0===e.w&&(e.w=this.network.upscaleFactor*this.gl.input.w),void 0===e.h&&(e.h=this.network.upscaleFactor*this.gl.input.h),this.renderSize=e,console.log("%cNew renderSize:","background:black; color: red",this.renderSize),this.gl.resizeRenderSize(e.w,e.h,this.network.upscaleFactor),null!==this.frameBuffer.inputTex&&setTimeout((()=>{t.network.renderRGB(t.gl.render_scale)})),t.metrics["Render Size"]=e}setInputSize(e={w:426,h:240}){this.gl.input={w:e.w,h:e.h},console.log("%cNew Input Size:","background:black; color: green",gl.input),this.network.resetTextureBuffers(),this.setProperties(this.renderSize)}async resetNetwork(e){this.frameBuffer.clearall(),this.network=await async function(e={name:"",version:"",tag:"",token:""},t,r){let i=null,n=null;try{n=await C(e.name,e.tag,e.version,e.token)}catch(e){throw console.log("%cParameter load failed:","background:black; color: yellow"),new Error(e)}if(!n)throw console.log("%cParameter load failed:","background:black; color: yellow"),new Error("");try{const s=F(e.name,e.token);i=await s,i=new i(t,r,n)}catch(e){throw console.log("%cNetwork load failed:","background:black; color: yellow"),new Error(e)}return i}({name:e.name,version:e.version,tag:e.tag},this.gl,this.network.frameBuffer),this.frameBuffer=this.network.frameBuffer,this.gl=this.network.gl,this.setProperties(this.renderSize)}changeNetwork(e){this.network=e,this.frameBuffer=this.network.frameBuffer,this.gl=this.network.gl}loadBitmap(e){const t=this.frameBuffer;this.network,t.setInputImage(e),this.render()}loadImage(e){const t=new Image;t.src=e;const r=this.frameBuffer,i=this,n=this.network;t.onload=function(){r.setInputImage(t),i.render(),n.getImageBytes()}}async render(){const e=this.gl,t=this.network;e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight),await t.feedForward(e.render_scale)}}(this.gl,this.networkInstance,this.frameBuffer,this.renderInputSize),this.canvas.style.left=`${this.margin.left}px`,this.canvas.style.top=`${this.margin.top}px`,this.initialRender(),this.initVideoEventRender(),this.initRenderLoop()):(document.dispatchEvent(this.events.error),this.disable())}initRenderLoop(){const e=this.video;(0,z.yA)(this.video)&&this.render(),e.addEventListener("play",function(){this.render()}.bind(this)),document.dispatchEvent(this.events.load)}initialRender(){const e=this.video;this.debug&&console.log("Calling Initial Render"),4===e.readyState&&setTimeout((()=>{this.renderAFrame()}),100),e.requestVideoFrameCallback&&e.requestVideoFrameCallback(function(){if((0,z.yA)(e))return null;this.renderAFrame()}.bind(this))}initVideoEventRender(){const e=this.video;e.oncanplaythrough=function(){this.renderAFrame()}.bind(this),e.onloadeddata=function(){this.renderAFrame()}.bind(this)}updateFrameMetrics(){if(this.frames.rendered.total++,this.frames.rendered.sinceTimestamp++,this.metrics.upscaledFrames++,performance.now()-this.prv>1e4){this.metrics.fps=JSON.parse(JSON.stringify(this.frames.rendered.sinceTimestamp)),this.prv=performance.now(),this.frames.rendered.sinceTimestamp=0;const e=this.video;let t=e.webkitDecodedFrameCount||e.mozPresentedFrames||e.decodedFrames||e.presentedFrames;t&&(this.frames.video.total=t,this.metrics.videoFrames=t,this.metrics.droppedFrames=this.metrics.videoFrames-this.metrics.upscaledFrames,this.debug&&console.log(`currentTime: ${this.video.currentTime}, FPS: ${this.metrics.fps}, Dropped frames: ${this.metrics.droppedFrames}, Video Frame: ${this.metrics.videoFrames}, Rendered frames: ${this.metrics.upscaledFrames}`),this.trackAnalytics("Playback Metrics",{FPS:this.metrics.fps,droppedFrames:this.metrics.droppedFrames,videoFrames:this.metrics.videoFrames,upscaledFrames:this.metrics.upscaledFrames,currentTime:this.video.currentTime}))}}renderVideoFrame(e){try{this.debugRender&&console.log("Calling renderVideoFrame in a loop",e),this.video&&this.frameBuffer&&this.renderer&&(this.renderAFrame(),this.updateFrameMetrics()),(0,z.yA)(this.video)&&this.enabled?(this.debugRender&&console.log("calling requestFrame"),this.requestFrame(this.video,this.renderVideoFrame.bind(this)),this.isPlaying=!0):(this.debugRender&&console.log("STOPPED playing"),document.dispatchEvent(this.events.stop),this.isPlaying=!1)}catch(e){console.error("Error in renderVideoFrame",e)}}requestFrame(e,t){if(this.reqHandle=this.reqHandle||{},this.reqHandle.useRAF){let e=(0,U.U7)(t);this.reqHandle.raf=e}else{let r=e.requestVideoFrameCallback(t);this.reqHandle.video=e,this.reqHandle.rfvc=r}}async updateNetworkOptions(e){await this.networkInstance.updateOptions(e)}cancelLastRender(){if(this.debugRender&&console.log("Canceling last render"),this.reqHandle=this.reqHandle||{},this.reqHandle.rfvc){let{video:e,rfvc:t}=this.reqHandle;e.cancelVideoFrameCallback(t),this.reqHandle.rfvc=null}if(this.reqHandle.raf){let{raf:e}=this.reqHandle;(0,U.Wx)(e),this.reqHandle.raf=null}}render(){this.renderCaller=(this.renderCaller||0)+1,this.debugRender&&console.log("Starting render call with isPlaying",this.isPlaying),this.prv=performance.now(),this.cancelLastRender(),this.renderVideoFrame(`my-render-${this.renderCaller}`),document.dispatchEvent(this.events.start)}initCanvas(){let e=document.createElement("canvas");return e.id="canv-"+this.id,e.style.position="absolute",e.style.left=this.margin.left,e.style.top=this.margin.top,window.upscalers=window.upscalers||{},window.upscalers[e.id]=this,e}}},8:function(e,t,r){"use strict";function i(e,t=1e5){return new Promise(((r,i)=>{const n=document.querySelector(e),s=setTimeout((function(){i("waitForElement failed for"+e)}),t);if(n)r(n);else{var o=new MutationObserver((t=>{t.forEach((t=>{const i=Array.from(t.addedNodes);for(const t of i)if(t.matches&&t.matches(e))return o.disconnect(),r(t),void clearTimeout(s)}))}));o.observe(document.documentElement,{childList:!0,subtree:!0})}}))}function n(e){return new Promise(((t,r)=>{e.videoWidth*e.videoHeight>0?t({width:e.videoWidth,height:e.videoHeight}):(e.onloadedmetadata=function(){t({width:e.videoWidth,height:e.videoHeight})},e.onerror=function(){r()})}))}r.d(t,{br:function(){return i},uF:function(){return n},yA:function(){return s},re:function(){return a}});const s=e=>!(e.paused||e.ended),o=()=>{console.log("npmBuild",!0),console.log("npmPackage","@vectorly-io/ai-filters");{let e="1.1.0";return console.log("npmCdnVersion",e),`https://cdn.vectorly.io/ai-filters/v1/${e}/`}},a=async(e,t,r)=>{let i={path:o()};try{i.token=await(async(e,t,r)=>{const i=o();let n=`${(e=>{let t,r=e||"production";switch(console.log(e,"production",r),console.log("SERVER_TYPE is",r),r){case"local":t="http://localhost:4000";break;case"staging":t="https://stream-staging.vectorly.io";break;case"production":default:t="https://stream.vectorly.io"}return t})(r)}/upscaler/models/${e.name}?token=${t}&path=${encodeURI(i)}&version=${e.version}&tag=${e.tag}`;const s=await fetch(n),{token:a}=await s.json();return console.log(s,a),a})(e,t,r)}catch(e){console.warn("Error fetching token",e)}return i}},820:function(e,t,r){"use strict";r.d(t,{Wx:function(){return u},U7:function(){return d}}),e=r.hmd(e);let i=1;const n="object"==typeof self&&self.self==self?self:"object"==typeof r.g&&r.g.global==r.g?r.g:{},s=Date.now();let o={},a=Date.now();const h=e=>{if("function"!=typeof e)throw new TypeError(e+" is not a function");const t=Date.now(),r=t-a,h=r>16?0:16-r,l=i++;return o[l]=e,Object.keys(o).length>1||setTimeout((()=>{a=t;const e=o;o={},Object.keys(e).forEach((t=>e[t](n.performance&&"function"==typeof n.performance.now?n.performance.now():Date.now()-s)))}),h),l},l=e=>"string"!=typeof e?h:""===e?n.requestAnimationFrame:n[e+"RequestAnimationFrame"],c=((e,t)=>{let r=0;for(;void 0!==e[r];){if(t(e[r]))return e[r];r+=1}})(["","webkit","moz","ms","o"],(e=>!!l(e))),d=l(c),u="string"!=typeof(f=c)?e=>{delete o[e]}:""===f?n.cancelAnimationFrame:n[f+"CancelAnimationFrame"]||n[f+"CancelRequestAnimationFrame"];var f;n.requestAnimationFrame=d,n.cancelAnimationFrame=u,e.exports&&(e.exports={requestAnimationFrame:d,cancelAnimationFrame:u})},33:function(e,t,r){"use strict";var i=function(){if("undefined"!=typeof Map)return Map;function e(e,t){var r=-1;return e.some((function(e,i){return e[0]===t&&(r=i,!0)})),r}return function(){function t(){this.__entries__=[]}return Object.defineProperty(t.prototype,"size",{get:function(){return this.__entries__.length},enumerable:!0,configurable:!0}),t.prototype.get=function(t){var r=e(this.__entries__,t),i=this.__entries__[r];return i&&i[1]},t.prototype.set=function(t,r){var i=e(this.__entries__,t);~i?this.__entries__[i][1]=r:this.__entries__.push([t,r])},t.prototype.delete=function(t){var r=this.__entries__,i=e(r,t);~i&&r.splice(i,1)},t.prototype.has=function(t){return!!~e(this.__entries__,t)},t.prototype.clear=function(){this.__entries__.splice(0)},t.prototype.forEach=function(e,t){void 0===t&&(t=null);for(var r=0,i=this.__entries__;r<i.length;r++){var n=i[r];e.call(t,n[1],n[0])}},t}()}(),n="undefined"!=typeof window&&"undefined"!=typeof document&&window.document===document,s=void 0!==r.g&&r.g.Math===Math?r.g:"undefined"!=typeof self&&self.Math===Math?self:"undefined"!=typeof window&&window.Math===Math?window:Function("return this")(),o="function"==typeof requestAnimationFrame?requestAnimationFrame.bind(s):function(e){return setTimeout((function(){return e(Date.now())}),1e3/60)},a=["top","right","bottom","left","width","height","size","weight"],h="undefined"!=typeof MutationObserver,l=function(){function e(){this.connected_=!1,this.mutationEventsAdded_=!1,this.mutationsObserver_=null,this.observers_=[],this.onTransitionEnd_=this.onTransitionEnd_.bind(this),this.refresh=function(e,t){var r=!1,i=!1,n=0;function s(){r&&(r=!1,e()),i&&h()}function a(){o(s)}function h(){var e=Date.now();if(r){if(e-n<2)return;i=!0}else r=!0,i=!1,setTimeout(a,20);n=e}return h}(this.refresh.bind(this))}return e.prototype.addObserver=function(e){~this.observers_.indexOf(e)||this.observers_.push(e),this.connected_||this.connect_()},e.prototype.removeObserver=function(e){var t=this.observers_,r=t.indexOf(e);~r&&t.splice(r,1),!t.length&&this.connected_&&this.disconnect_()},e.prototype.refresh=function(){this.updateObservers_()&&this.refresh()},e.prototype.updateObservers_=function(){var e=this.observers_.filter((function(e){return e.gatherActive(),e.hasActive()}));return e.forEach((function(e){return e.broadcastActive()})),e.length>0},e.prototype.connect_=function(){n&&!this.connected_&&(document.addEventListener("transitionend",this.onTransitionEnd_),window.addEventListener("resize",this.refresh),h?(this.mutationsObserver_=new MutationObserver(this.refresh),this.mutationsObserver_.observe(document,{attributes:!0,childList:!0,characterData:!0,subtree:!0})):(document.addEventListener("DOMSubtreeModified",this.refresh),this.mutationEventsAdded_=!0),this.connected_=!0)},e.prototype.disconnect_=function(){n&&this.connected_&&(document.removeEventListener("transitionend",this.onTransitionEnd_),window.removeEventListener("resize",this.refresh),this.mutationsObserver_&&this.mutationsObserver_.disconnect(),this.mutationEventsAdded_&&document.removeEventListener("DOMSubtreeModified",this.refresh),this.mutationsObserver_=null,this.mutationEventsAdded_=!1,this.connected_=!1)},e.prototype.onTransitionEnd_=function(e){var t=e.propertyName,r=void 0===t?"":t;a.some((function(e){return!!~r.indexOf(e)}))&&this.refresh()},e.getInstance=function(){return this.instance_||(this.instance_=new e),this.instance_},e.instance_=null,e}(),c=function(e,t){for(var r=0,i=Object.keys(t);r<i.length;r++){var n=i[r];Object.defineProperty(e,n,{value:t[n],enumerable:!1,writable:!1,configurable:!0})}return e},d=function(e){return e&&e.ownerDocument&&e.ownerDocument.defaultView||s},u=w(0,0,0,0);function f(e){return parseFloat(e)||0}function p(e){for(var t=[],r=1;r<arguments.length;r++)t[r-1]=arguments[r];return t.reduce((function(t,r){return t+f(e["border-"+r+"-width"])}),0)}var g="undefined"!=typeof SVGGraphicsElement?function(e){return e instanceof d(e).SVGGraphicsElement}:function(e){return e instanceof d(e).SVGElement&&"function"==typeof e.getBBox};function m(e){return n?g(e)?function(e){var t=e.getBBox();return w(0,0,t.width,t.height)}(e):function(e){var t=e.clientWidth,r=e.clientHeight;if(!t&&!r)return u;var i=d(e).getComputedStyle(e),n=function(e){for(var t={},r=0,i=["top","right","bottom","left"];r<i.length;r++){var n=i[r],s=e["padding-"+n];t[n]=f(s)}return t}(i),s=n.left+n.right,o=n.top+n.bottom,a=f(i.width),h=f(i.height);if("border-box"===i.boxSizing&&(Math.round(a+s)!==t&&(a-=p(i,"left","right")+s),Math.round(h+o)!==r&&(h-=p(i,"top","bottom")+o)),!function(e){return e===d(e).document.documentElement}(e)){var l=Math.round(a+s)-t,c=Math.round(h+o)-r;1!==Math.abs(l)&&(a-=l),1!==Math.abs(c)&&(h-=c)}return w(n.left,n.top,a,h)}(e):u}function w(e,t,r,i){return{x:e,y:t,width:r,height:i}}var y=function(){function e(e){this.broadcastWidth=0,this.broadcastHeight=0,this.contentRect_=w(0,0,0,0),this.target=e}return e.prototype.isActive=function(){var e=m(this.target);return this.contentRect_=e,e.width!==this.broadcastWidth||e.height!==this.broadcastHeight},e.prototype.broadcastRect=function(){var e=this.contentRect_;return this.broadcastWidth=e.width,this.broadcastHeight=e.height,e},e}(),v=function(e,t){var r,i,n,s,o,a,h,l=(i=(r=t).x,n=r.y,s=r.width,o=r.height,a="undefined"!=typeof DOMRectReadOnly?DOMRectReadOnly:Object,h=Object.create(a.prototype),c(h,{x:i,y:n,width:s,height:o,top:n,right:i+s,bottom:o+n,left:i}),h);c(this,{target:e,contentRect:l})},b=function(){function e(e,t,r){if(this.activeObservations_=[],this.observations_=new i,"function"!=typeof e)throw new TypeError("The callback provided as parameter 1 is not a function.");this.callback_=e,this.controller_=t,this.callbackCtx_=r}return e.prototype.observe=function(e){if(!arguments.length)throw new TypeError("1 argument required, but only 0 present.");if("undefined"!=typeof Element&&Element instanceof Object){if(!(e instanceof d(e).Element))throw new TypeError('parameter 1 is not of type "Element".');var t=this.observations_;t.has(e)||(t.set(e,new y(e)),this.controller_.addObserver(this),this.controller_.refresh())}},e.prototype.unobserve=function(e){if(!arguments.length)throw new TypeError("1 argument required, but only 0 present.");if("undefined"!=typeof Element&&Element instanceof Object){if(!(e instanceof d(e).Element))throw new TypeError('parameter 1 is not of type "Element".');var t=this.observations_;t.has(e)&&(t.delete(e),t.size||this.controller_.removeObserver(this))}},e.prototype.disconnect=function(){this.clearActive(),this.observations_.clear(),this.controller_.removeObserver(this)},e.prototype.gatherActive=function(){var e=this;this.clearActive(),this.observations_.forEach((function(t){t.isActive()&&e.activeObservations_.push(t)}))},e.prototype.broadcastActive=function(){if(this.hasActive()){var e=this.callbackCtx_,t=this.activeObservations_.map((function(e){return new v(e.target,e.broadcastRect())}));this.callback_.call(e,t,e),this.clearActive()}},e.prototype.clearActive=function(){this.activeObservations_.splice(0)},e.prototype.hasActive=function(){return this.activeObservations_.length>0},e}(),_="undefined"!=typeof WeakMap?new WeakMap:new i,E=function e(t){if(!(this instanceof e))throw new TypeError("Cannot call a class as a function.");if(!arguments.length)throw new TypeError("1 argument required, but only 0 present.");var r=l.getInstance(),i=new b(t,r,this);_.set(this,i)};["observe","unobserve","disconnect"].forEach((function(e){E.prototype[e]=function(){var t;return(t=_.get(this))[e].apply(t,arguments)}}));var T=void 0!==s.ResizeObserver?s.ResizeObserver:E;t.Z=T},877:function(e,t,r){var i=r(570),n=r(171),s=n;s.v1=i,s.v4=n,e.exports=s},327:function(e){for(var t=[],r=0;r<256;++r)t[r]=(r+256).toString(16).substr(1);e.exports=function(e,r){var i=r||0,n=t;return[n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],"-",n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]],n[e[i++]]].join("")}},217:function(e){var t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(t){var r=new Uint8Array(16);e.exports=function(){return t(r),r}}else{var i=new Array(16);e.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),i[t]=e>>>((3&t)<<3)&255;return i}}},570:function(e,t,r){var i,n,s=r(217),o=r(327),a=0,h=0;e.exports=function(e,t,r){var l=t&&r||0,c=t||[],d=(e=e||{}).node||i,u=void 0!==e.clockseq?e.clockseq:n;if(null==d||null==u){var f=s();null==d&&(d=i=[1|f[0],f[1],f[2],f[3],f[4],f[5]]),null==u&&(u=n=16383&(f[6]<<8|f[7]))}var p=void 0!==e.msecs?e.msecs:(new Date).getTime(),g=void 0!==e.nsecs?e.nsecs:h+1,m=p-a+(g-h)/1e4;if(m<0&&void 0===e.clockseq&&(u=u+1&16383),(m<0||p>a)&&void 0===e.nsecs&&(g=0),g>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");a=p,h=g,n=u;var w=(1e4*(268435455&(p+=122192928e5))+g)%4294967296;c[l++]=w>>>24&255,c[l++]=w>>>16&255,c[l++]=w>>>8&255,c[l++]=255&w;var y=p/4294967296*1e4&268435455;c[l++]=y>>>8&255,c[l++]=255&y,c[l++]=y>>>24&15|16,c[l++]=y>>>16&255,c[l++]=u>>>8|128,c[l++]=255&u;for(var v=0;v<6;++v)c[l+v]=d[v];return t||o(c)}},171:function(e,t,r){var i=r(217),n=r(327);e.exports=function(e,t,r){var s=t&&r||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var o=(e=e||{}).random||(e.rng||i)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t)for(var a=0;a<16;++a)t[s+a]=o[a];return t||n(o)}},618:function(e){"use strict";function t(e,t){if(!l)return!1;const i=e.buffer;let n=d.get(i);if(null==n){if((n=r.validate(i))&&t)try{new r.Instance(new r.Module(i)).exports[0]()}catch(e){n=!1}d.set(i,n)}return n}const r=WebAssembly,i=(...e)=>Uint8Array.of(0,97,115,109,1,0,0,0,...e),n=(...e)=>Uint32Array.of(1836278016,1,...e),s=(...e)=>n(1610679297,33751040,...e,40239360,259),o=(...e)=>i(1,4,1,96,0,0,3,2,1,0,...e,11,0,10,4,110,97,109,101,2,3,1,0,0),a=(...e)=>Uint16Array.of(24832,28019,1,0,1025,24577,0,515,1,...e),h=(...e)=>a(...e,2842,4096,28164,28001,357,260,256,560,259,0),l="object"==typeof r,c=e=>l&&"function"==typeof e,d=new WeakMap,u=n(1610679553,58589440,117440770,805372165,101318656,1107297281,268438272,1835101700,17039717,36700416,259),f=a(773,1,2561,269,11,65,65,65,3068,2816,2560,28164,28001,613,259,0),p=n(1610679297,33751040,134873089,100664833,185276736),g=i(2,8,1,1,97,1,98,3,127,1,6,6,1,127,1,65,0,11,7,5,1,1,97,3,1,0,8,4,110,97,109,101,2,1,0),m=Uint16Array.of(24832,28019,1,0,1537,24577,512,32639,515,1,2058,1537,16640,16640,2816,2560,28164,28001,613,259,0),w=h(3082,2561,17152,0,0,252),y=h(2058,1537,16640,49152),v=s(101318657,301990913,268438272,1835101700,17039717),b=o(5,4,1,3,1,1,10,7,1,5,0,254,3,0),_=s(84344833,6357249,17369600,4259847,186257917,1845758464),E=o(10,7,1,5,0,208,112,26);e.exports={support:(e=1)=>l&&t(Uint32Array.of(1836278016,e)),get supportStreaming(){return c(r.instantiateStreaming)},feature:{get bigInt(){return t(u,!0)},get bulk(){return t(f)},get exceptions(){return t(p)},get mutableGlobal(){return t(g)},get multiValue(){return t(m)},get saturateConversions(){return t(w)},get signExtensions(){return t(y)},get tailCall(){return t(v)},get threads(){return t(b)},get simd(){return t(_)},get references(){return t(E)},get typeReflection(){return c(r.Memory.type)},get funcReferences(){return c(r.Function)}}}},477:function(e){"use strict";e.exports=function(e,t,r,i){var n=self||window;try{try{var s;try{s=new n.Blob([e])}catch(t){(s=new(n.BlobBuilder||n.WebKitBlobBuilder||n.MozBlobBuilder||n.MSBlobBuilder)).append(e),s=s.getBlob()}var o=n.URL||n.webkitURL,a=o.createObjectURL(s),h=new n[t](a,r);return o.revokeObjectURL(a),h}catch(i){return new n[t]("data:application/javascript,".concat(encodeURIComponent(e)),r)}}catch(e){if(!i)throw Error("Inline worker is not supported");return new n[t](i,r)}}},306:function(e){"use strict";e.exports={i8:"1.1.0"}}},i={};function n(e){var t=i[e];if(void 0!==t)return t.exports;var s=i[e]={id:e,loaded:!1,exports:{}};return r[e](s,s.exports,n),s.loaded=!0,s.exports}n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,{a:t}),t},t=Object.getPrototypeOf?function(e){return Object.getPrototypeOf(e)}:function(e){return e.__proto__},n.t=function(r,i){if(1&i&&(r=this(r)),8&i)return r;if("object"==typeof r&&r){if(4&i&&r.__esModule)return r;if(16&i&&"function"==typeof r.then)return r}var s=Object.create(null);n.r(s);var o={};e=e||[null,t({}),t([]),t(t)];for(var a=2&i&&r;"object"==typeof a&&!~e.indexOf(a);a=t(a))Object.getOwnPropertyNames(a).forEach((function(e){o[e]=function(){return r[e]}}));return o.default=function(){return r},n.d(s,o),s},n.d=function(e,t){for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.hmd=function(e){return(e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:function(){throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},function(){var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");r.length&&(e=r[r.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e}();var s={};return function(){"use strict";var e=n(877),t=n(306),r=n(8),i=n(618);const o={...i.feature};console.log(o),console.log("SIMD",i.feature.simd),s.default=class{constructor(r,i){this.type="background",this.params=i||{},this.enableOffscreen=this.checkSupport(i.offscreen),this.debug=this.params.debug||!1,this.id=i.id||(0,e.v4)(),this.version=t.i8,this.serverType=this.params.serverType||"",this.defaultBackground="https://files.vectorly.io/demo/background-filter/images/virtual-background-1.jpg",this.defaultBlurRadius=5,this.background=this.params.background||this.defaultBackground,this.blurRadius=this.params.blurRadius||this.defaultBlurRadius,this.error=null,this.loadP=this.loadCore(this.enableOffscreen);try{this.input=this._getInput(r),this.inputClone=this.input?this.input.clone():null,this.registerInputListeners(),this.log("Input to BackgroundFilter is",this.input),this.video=this.video||this._initVideo(),this.video.id="vid-"+this.id,this.processorP=this._initializeCoreNetwork(),this.outputP=this._createNewStream()}catch(e){throw this.error=e,e}}async loadCore(e){let t;return!0===e?(t=await Promise.resolve().then(n.bind(n,645)),this.vectorlyCore=t.default,!0):(t=await Promise.resolve().then(n.bind(n,443)),this.vectorlyCore=t.default,!0)}checkSupport(e){const t=Boolean(HTMLCanvasElement.prototype.transferControlToOffscreen);return null==e?t:!0===e||"true"===e?(t||console.warn(`transferControlToOffscreen is not supported but params.offscreen is set to ${e}; Set params.offscreen to null to default to offscreen if supported`),!0):(console.log(`params.offscreen is ${e}; running on main thread`),!1)}registerInputListeners(){const e=this.input,t=this.originalInput;if(e instanceof MediaStream&&t instanceof MediaStream){let e=t.getVideoTracks();const r=[];console.log("Input tracks in registerInputListeners",e,t);for(let t=0;t<e.length;++t){const i=e[t];console.log(t,"tracks",i.id),r.push(i.id),i.addEventListener("ended",(()=>{console.log("In listener",this.stop),this.stop()}))}const i=this;MediaStreamTrack.prototype._stop=MediaStreamTrack.prototype.stop;const n=MediaStreamTrack.prototype._stop;MediaStreamTrack.prototype.stop=function(){const e=arguments;console.log("in proto",e,this,i,r),n.call(this),r.indexOf(this.id)>-1&&i.stop()}}}_getInput(e){if(e instanceof MediaStream)return this.originalInput=e,e.clone();if(e instanceof HTMLMediaElement)return e.captureStream?e.captureStream():e.mozCaptureStream?e.mozCaptureStream():(this.video=e,null);{const t=`In _getInput; input is of invalid type: type ${typeof e} - ${e}`;throw console.error(t),new Error(t)}}async _initializeCoreNetwork(){const e=await(0,r.uF)(this.video);await this.loadP;const t=new this.vectorlyCore(this.video,{stream:this.input,token:this.params.token,id:this.id,networkParams:{name:"background_meet",tag:"general",version:"0"},networkOptions:{background:this._getBackground(this.background)},renderSize:{w:e.width,h:e.height},debug:this.debug,debugRender:!1,container:"disable",serverType:this.serverType,analyticsEnabled:this.params.analyticsEnabled});console.log(t,t.initialized);let i=await t.initialized;if(console.log("In _initializeCoreNetwork",i,t),!1===i)throw console.log("Initialized is",this.initialized,t.error),new Error(t.error);return t.canvas.style.visibility="hidden",{canvas:t.renderCanvas||t.canvas,processor:t}}_getBackground(e){return"blur"===e?{type:"blur",radius:this.blurRadius}:(e||(e=this.defaultBackground,console.warn("in background is not given; Setting to defaultBackground",this.defaultBackground)),{type:"virtual",image:e})}_getBlurRadius(e){return(!e||e<1)&&(console.warn("in blurRadius:",e,"should be greater than equal to 1; Setting to defaultBlurRadius",this.defaultBlurRadius),e=this.defaultBlurRadius),{type:"blur",radius:e}}async changeBackground(e){console.log("Change background to",e,"from",this.background);try{const{processor:t}=await this.processorP;await t.updateNetworkOptions({background:this._getBackground(e)}),this.background=e}catch(e){throw console.log("Error",e),e}}async changeBlurRadius(e){try{const{processor:t}=await this.processorP;console.log("Change blur radius to",e,"from",this.blurRadius),await t.updateNetworkOptions({background:this._getBlurRadius(e)}),this.blurRadius=e}catch(e){throw console.log("Error",e),e}}async _createNewStream(){try{const{canvas:e,processor:t}=await this.processorP;return this.canvas=e,this.processor=t,this.processOutput=e.captureStream(),this.output=this.processOutput,this.output}catch(e){throw this.log("ERROR in createNewStream",e),e}}async getOutput(){try{return await this.outputP}catch(e){throw console.error(this.error),e}}async disable(){return this.output=this.inputClone,await this.processorP,this.processor.disable(),this.video.style.visibility="hidden",this.output}async enable(){return await this.processorP,this.processor.enable(),this.output=this.processOutput,this.canvas.style.visibility="hidden",this.output}_initVideo(){let e=document.createElement("video");return e.style.visibility="hidden",e.style.display="none",e.id="vid-"+this.id,e.setAttribute("playsinline",null),e.setAttribute("autoplay",null),e.srcObject=this.input,document.body.appendChild(e),(0,r.yA)(e)||e.play(),e}async changeInput(e){this.input=this._getInput(e),this.input&&(this.inputClone=this.input?this.input.clone():null,this.video.srcObject=this.input,this.processor.updateStream&&this.processor.updateStream(this.input)),this.registerInputListeners();const t=await(0,r.uF)(this.video);this.processor.setRenderSize({w:t.width,h:t.height})}stop(){let e=this.input.getVideoTracks();console.log("Input tracks",e);for(let t=0;t<e.length;++t)e[t]._stop();e=this.inputClone.getVideoTracks();for(let t=0;t<e.length;++t)e[t]._stop()}log(){this.debug&&console.log.apply(null,arguments)}}}(),s.default}()}));